import{s as t}from"./supabaseClient.CPicN285.js";import{g as p}from"./entry.Do23-0vY.js";import"./index.Vv2yv23T.js";import{t as i}from"./Toaster.svelte_svelte_type_style_lang.BcvbULy5.js";import{p as f}from"./profileStore.DorDk9Q6.js";const P={async updateEmail(e){try{const{data:r}=await t.auth.getSession();if(!r?.session?.user)return i.error("You must be logged in to update your email"),p("/login"),{success:!1,message:"Not logged in",errorFields:[]};if(!e||e==="")return{success:!1,message:"An email address is required",errorFields:["email"]};if(!e.includes("@"))return{success:!1,message:"A valid email address is required",errorFields:["email"]};const{error:o}=await t.auth.updateUser({email:e});return o?(console.error("Error updating email:",o),{success:!1,message:o.message||"Unknown error 001. If this persists please contact us.",errorFields:["email"]}):(i.success("Email update initiated. Please check your inbox for verification."),{success:!0,message:"Email update initiated",email:e})}catch(r){return console.error("Error in updateEmail:",r),{success:!1,message:"Unknown error 001. If this persists please contact us.",errorFields:[]}}},async updatePassword(e,r,o){try{const{data:n}=await t.auth.getSession();if(!n?.session?.user)return i.error("You must be logged in to update your password"),p("/login"),{success:!1,message:"Not logged in",errorFields:[]};const u=n.session.user?.amr?.find(c=>c.method==="recovery"),l=u&&!o;if(l&&Date.now()-u.timestamp*1e3>1e3*60*15)return{success:!1,message:'Recovery code expired. Please log out, then use "Forgot Password" on the sign in page to reset your password. Codes are valid for 15 minutes.',errorFields:[]};const a=[];let s=null;if(e||(s="You must type a new password",a.push("newPassword1")),r||(s="You must type the new password twice",a.push("newPassword2")),e.length<6&&(s="The new password must be at least 6 characters long",a.push("newPassword1")),e.length>72&&(s="The new password can be at most 72 characters long",a.push("newPassword1")),e!=r&&(s="The passwords don't match",a.push("newPassword1"),a.push("newPassword2")),!o&&!l&&(s="You must include your current password. If you forgot it, sign out then use 'forgot password' on the sign in page.",a.push("currentPassword")),s)return{success:!1,message:s,errorFields:[...new Set(a)]};if(!l){const{error:c}=await t.auth.signInWithPassword({email:n.session.user.email||"",password:o});if(c)return i.error("Incorrect password. Please try again."),p("/login/current_password_error"),{success:!1,message:"Incorrect password",errorFields:["currentPassword"]}}const{error:d}=await t.auth.updateUser({password:e});return d?{success:!1,message:d.message||"Unknown error 004. If this persists please contact us.",errorFields:[]}:(i.success("Password updated successfully"),{success:!0,message:"Password updated successfully"})}catch(n){return console.error("Error in updatePassword:",n),{success:!1,message:"Unknown error 004. If this persists please contact us.",errorFields:[]}}},async updateProfile(e,r="",o="",n){try{console.log("Updating profile from client API");const{data:u}=await t.auth.getSession();if(!u?.session?.user)return i.error("You must be logged in to update your profile"),p("/login"),{success:!1,message:"Not logged in",errorFields:[]};if(!e)return{success:!1,message:"Name is required",errorFields:["fullName"]};const l=u.session.user.id,a=u.session.user.email,s={id:l,email:a,full_name:e,updated_at:new Date};r!==void 0&&(s.company_name=r),o!==void 0&&(s.website=o),n!==void 0&&(s.survey_completed=n),console.log("Profile data:",s);const{error:d}=await t.from("profiles").upsert(s);if(d)return console.error("Supabase profile error:",d),{success:!1,message:d.message||"Unknown error 005. If this persists please contact us.",errorFields:[]};if(s.full_name){const{error:c}=await t.auth.updateUser({data:{name:e}});c&&console.error("Supabase metadata error:",c)}return await t.auth.refreshSession(),f&&typeof f.loadProfile=="function"&&await f.loadProfile(l),i.success("Profile updated successfully"),{success:!0,message:"Profile updated successfully",profile:s}}catch(u){return console.error("Error in updateProfile:",u),{success:!1,message:"Unknown error 005. If this persists please contact us.",errorFields:[]}}},async deleteAccount(e){try{const{data:r}=await t.auth.getSession();if(!r?.session?.user)return i.error("You must be logged in to delete your account"),p("/login"),{success:!1,message:"Not logged in",errorFields:[]};if(!e)return{success:!1,message:"You must provide your current password to delete your account. If you forgot it, sign out then use 'forgot password' on the sign in page.",errorFields:["currentPassword"]};const{error:o}=await t.auth.signInWithPassword({email:r.session.user.email||"",password:e});return o?(i.error("Incorrect password. Please try again."),p("/login/current_password_error"),{success:!1,message:"Incorrect password",errorFields:["currentPassword"]}):(i.info("Account deletion requires admin privileges. Please contact support."),{success:!1,message:"Account deletion via client API is not supported. Please contact support.",errorFields:[]})}catch(r){return console.error("Error in deleteAccount:",r),{success:!1,message:"Unknown error 002. If this persists please contact us.",errorFields:[]}}}};export{P as u};

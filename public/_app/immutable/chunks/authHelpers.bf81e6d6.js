import{a as u,s as c,i as h}from"./sessionStore.a0feee67.js";import{g as _}from"./navigation.f06e96a7.js";import{P as p}from"./scheduler.0ff5556b.js";const f=new Set;async function w(r,e="POST",t={}){var o,l;const s=p(c);if(!((o=s==null?void 0:s.user)!=null&&o.id)){await h();const a=p(c);if(!((l=a==null?void 0:a.user)!=null&&l.id))throw new Error("Authentication required")}const i=p(c);return fetch(r,{method:e,headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:e!=="GET"?JSON.stringify(t):void 0})}async function A(r){var o,l;if(!r||!r.user)return console.log("[Auth Helper] No valid session data provided"),!1;const e=r.user.id;if(f.has(e))return console.log("[Auth Helper] Already processed user session:",e),!0;console.log("[Auth Helper] Checking profile for user:",e),f.add(e);const{data:t,error:s}=await u.from("profiles").select("id, email, full_name, avatar_url, created_at").eq("id",e).single(),i={id:e,email:r.user.email,full_name:((o=r.user.user_metadata)==null?void 0:o.full_name)||null,avatar_url:((l=r.user.user_metadata)==null?void 0:l.avatar_url)||null,updated_at:new Date().toISOString(),last_sign_in:r.user.last_sign_in||new Date().toISOString()};if(s&&s.code==="PGRST116"){console.log("[Auth Helper] No profile found, creating new profile");const{error:a}=await u.from("profiles").insert({...i,created_at:new Date().toISOString(),onboarded:!1});return a&&a.code!=="23505"?(console.error("[Auth Helper] Error creating profile:",a),!1):(console.log("[Auth Helper] Profile created successfully"),await g(e),!0)}if(t){if(console.log("[Auth Helper] Existing profile found:",t),!t.email||!t.full_name&&i.full_name||!t.avatar_url&&i.avatar_url){console.log("[Auth Helper] Profile exists but needs updating with missing data");const n={updated_at:i.updated_at};t.email||(n.email=i.email),!t.full_name&&i.full_name&&(n.full_name=i.full_name),!t.avatar_url&&i.avatar_url&&(n.avatar_url=i.avatar_url);const{error:d}=await u.from("profiles").update(n).eq("id",e);if(d)return console.error("[Auth Helper] Error updating profile:",d),!1;console.log("[Auth Helper] Profile updated successfully with data:",n)}else{console.log("[Auth Helper] Profile exists and has all required data, just updating timestamps");const{error:n}=await u.from("profiles").update({last_sign_in:i.last_sign_in}).eq("id",e);n?console.error("[Auth Helper] Error updating profile timestamp:",n):console.log("[Auth Helper] Profile timestamp updated successfully")}return await g(e),!0}return console.error("[Auth Helper] Unexpected state in profile check"),!1}async function g(r){try{console.log("[Auth Helper] Checking for existing subscription for user:",r);const{data:e,error:t}=await u.from("user_subscriptions").select("user_id").eq("user_id",r);if(t)console.log("[Auth Helper] Error checking subscriptions (will try to create):",t.code);else if(e&&e.length>0)return console.log(`[Auth Helper] Found ${e.length} existing subscription(s)`),!0;console.log("[Auth Helper] No valid subscription found, creating one");const{error:s}=await u.from("user_subscriptions").insert({user_id:r,subscription:"FREE",marker_limit:100,trail_limit:1e5,current_seats:1,updated_at:new Date().toISOString(),created_at:new Date().toISOString()});return s?s.code==="23505"?(console.log("[Auth Helper] Subscription already exists (unique constraint)"),!0):(console.log("[Auth Helper] Non-critical error creating subscription:",s.code),!1):(console.log("[Auth Helper] Free subscription created successfully"),!0)}catch(e){return console.log("[Auth Helper] Unexpected error in subscription management:",e),!1}}function E(r="/account"){console.log("[Auth Helper] Setting up auth listener with redirect to:",r);let e=!1;const t=async()=>{const{data:{session:o}}=await u.auth.getSession();o?(console.log("[Auth Helper] Found existing session on page load, processing..."),await s("EXISTING_SESSION",o)):console.log("[Auth Helper] No existing session found")},s=async(o,l)=>{var a;if(console.log("[Auth Helper] Auth event:",o,"User:",(a=l==null?void 0:l.user)==null?void 0:a.id),!l){console.log("[Auth Helper] No session in auth event");return}if(o==="INITIAL_SESSION"){console.log("[Auth Helper] Ignoring INITIAL_SESSION event");return}if((o==="SIGNED_IN"||o==="USER_UPDATED"||o==="EXISTING_SESSION")&&!e){console.log("[Auth Helper] Processing auth event:",o),e=!0;try{const n=await A(l);console.log("[Auth Helper] Profile update/creation result:",n),window.location.pathname!==r?(console.log(`[Auth Helper] Auth processing complete, redirecting to ${r}`),_(r)):console.log(`[Auth Helper] Already on ${r}, no redirect needed`)}catch(n){console.error("[Auth Helper] Error processing authentication:",n)}finally{e=!1}}};setTimeout(t,0);const{data:{subscription:i}}=u.auth.onAuthStateChange(s);return{data:{subscription:i},checkNow:t}}export{w as a,E as s,A as u};

import{i as ae,s as X,a as g}from"../chunks/sessionStore.rIZpZ3yf.js";import"../chunks/index.I1wl8Txd.js";import{P as ne,s as ie,d as C,i as B,x as N,l as K,z as Q,n as M,b as k,c as w,g as U,j as P,q as le,a as y,A as ce,e as R,f as G,h as ue,k as F,t as de,m as _e,u as me,o as fe,p as pe}from"../chunks/scheduler.BVGjjnGO.js";import{S as ge,i as he,t as V,a as H,g as be,e as ye}from"../chunks/index.Vv2yv23T.js";import{g as S}from"../chunks/entry.BMnqIGFd.js";import{p as ve}from"../chunks/stores.CK5m2G91.js";import"../chunks/Toaster.svelte_svelte_type_style_lang.BcvbULy5.js";import{p as ke}from"../chunks/profileStore.DorDk9Q6.js";import{s as xe}from"../chunks/subscriptionStore.DSonUdJX.js";import{c as Se}from"../chunks/connectedMapStore.vcjAOVZs.js";import{m as we}from"../chunks/mapActivityStore.BMkPVnUJ.js";import{o as Pe,s as Ce}from"../chunks/operationStore.DMok4-vU.js";const qe=async()=>{try{return{sessionStatus:"initializing",sessionPromise:ae().then(()=>{const t=ne(X);return{isAuthenticated:!!t?.user?.id,userId:t?.user?.id}})}}catch(i){return console.error("Error in layout load:",i),{sessionStatus:"error",error:i.message}}},Ae=!1,We=Object.freeze(Object.defineProperty({__proto__:null,load:qe,ssr:Ae},Symbol.toStringTag,{value:"Module"}));function De(i){let t,s,e,r;const u=[Me,Le,je],d=[];function c(n,m){return n[0]?0:n[1]?1:2}return t=c(i),s=d[t]=u[t](i),{c(){s.c(),e=N()},l(n){s.l(n),e=N()},m(n,m){d[t].m(n,m),B(n,e,m),r=!0},p(n,m){let _=t;t=c(n),t===_?d[t].p(n,m):(be(),V(d[_],1,1,()=>{d[_]=null}),ye(),s=d[t],s?s.p(n,m):(s=d[t]=u[t](n),s.c()),H(s,1),s.m(e.parentNode,e))},i(n){r||(H(s),r=!0)},o(n){V(s),r=!1},d(n){n&&C(e),d[t].d(n)}}}function je(i){let t;const s=i[4].default,e=_e(s,i,i[3],null);return{c(){e&&e.c()},l(r){e&&e.l(r)},m(r,u){e&&e.m(r,u),t=!0},p(r,u){e&&e.p&&(!t||u&8)&&me(e,s,r,r[3],t?pe(s,r[3],u,null):fe(r[3]),null)},i(r){t||(H(e,r),t=!0)},o(r){V(e,r),t=!1},d(r){e&&e.d(r)}}}function Le(i){let t,s,e,r="Error Loading Account",u,d,c=(i[1].message||"Unknown error occurred")+"",n,m,_,p,O="Try Again",j,b,E="Back to Login",q,I;return{c(){t=P("div"),s=P("div"),e=P("h2"),e.textContent=r,u=F(),d=P("p"),n=de(c),m=F(),_=P("div"),p=P("button"),p.textContent=O,j=F(),b=P("a"),b.textContent=E,this.h()},l(v){t=w(v,"DIV",{class:!0});var o=R(t);s=w(o,"DIV",{class:!0});var l=R(s);e=w(l,"H2",{class:!0,"data-svelte-h":!0}),U(e)!=="svelte-135zzb6"&&(e.textContent=r),u=G(l),d=w(l,"P",{class:!0});var h=R(d);n=ue(h,c),h.forEach(C),m=G(l),_=w(l,"DIV",{class:!0});var a=R(_);p=w(a,"BUTTON",{class:!0,"data-svelte-h":!0}),U(p)!=="svelte-9gqfuk"&&(p.textContent=O),j=G(a),b=w(a,"A",{href:!0,class:!0,"data-svelte-h":!0}),U(b)!=="svelte-abcnec"&&(b.textContent=E),a.forEach(C),l.forEach(C),o.forEach(C),this.h()},h(){k(e,"class","text-2xl font-bold text-red-700"),k(d,"class","mt-2 text-red-600"),k(p,"class","rounded bg-primary px-4 py-2 text-white"),k(b,"href","/login"),k(b,"class","rounded border border-gray-300 bg-white px-4 py-2 text-gray-700"),k(_,"class","mt-6 flex justify-center space-x-4"),k(s,"class","max-w-md rounded-lg bg-red-50 p-6 text-center shadow-lg"),k(t,"class","flex h-screen w-full items-center justify-center")},m(v,o){B(v,t,o),y(t,s),y(s,e),y(s,u),y(s,d),y(d,n),y(s,m),y(s,_),y(_,p),y(_,j),y(_,b),q||(I=ce(p,"click",i[5]),q=!0)},p(v,o){o&2&&c!==(c=(v[1].message||"Unknown error occurred")+"")&&le(n,c)},i:M,o:M,d(v){v&&C(t),q=!1,I()}}}function Me(i){let t,s='<div class="flex flex-col items-center"><div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div> <p class="mt-4 text-xl font-medium">Loading your account...</p></div>';return{c(){t=P("div"),t.innerHTML=s,this.h()},l(e){t=w(e,"DIV",{class:!0,"data-svelte-h":!0}),U(t)!=="svelte-1g19t2"&&(t.innerHTML=s),this.h()},h(){k(t,"class","flex h-screen w-full items-center justify-center")},m(e,r){B(e,t,r)},p:M,i:M,o:M,d(e){e&&C(t)}}}function Oe(i){let t,s,e=De(i);return{c(){e&&e.c(),t=N()},l(r){e&&e.l(r),t=N()},m(r,u){e&&e.m(r,u),B(r,t,u),s=!0},p(r,[u]){e.p(r,u)},i(r){s||(H(e),s=!0)},o(r){V(e),s=!1},d(r){r&&C(t),e&&e.d(r)}}}function Ee(i,t,s){let e,r;K(i,X,o=>s(9,e=o)),K(i,ve,o=>s(10,r=o));let{$$slots:u={},$$scope:d}=t,{data:c}=t,n=c.sessionStatus==="loading"||c.sessionStatus==="initializing",m=c.error||null,_=!1,p=null,O=!1;console.log("Account layout initializing"),console.log("Current session status:",c.sessionStatus),console.log("Current session state:",e);async function j(){if(!e?.user?.id)return null;const o=e.user.id;console.log("Loading user data for:",o);try{const[l,h]=await Promise.all([g.from("profiles").select("*").eq("id",o).single(),g.from("user_subscriptions").select("*").eq("user_id",o).single()]),a=l.data,f=h.data;if(console.log("Profile loaded:",a?.id),a&&ke.set({id:a.id,full_name:a.full_name,email:a.email,company_name:a.company_name,website:a.website,user_type:a.role,master_map_id:a.master_map_id,recent_maps:a.recent_maps,selected_operation_id:a.selected_operation_id}),f&&xe.set({subscription:f.subscription,marker_limit:f.marker_limit,trail_limit:f.trail_limit,lingering_seats:f.lingering_seats,current_seats:f.current_seats,next_billing_date:f.next_billing_date}),!a?.master_map_id)return{profile:a,subscription:f,connected_map:null};const[A,Y,Z]=await Promise.all([g.from("master_maps").select("*").eq("id",a.master_map_id).single(),Promise.all([g.from("map_markers").select("id",{count:"exact"}).eq("master_map_id",a.master_map_id),g.from("trail_data").select("id",{count:"exact"}).eq("master_map_id",a.master_map_id),g.from("profiles").select("id, full_name").eq("master_map_id",a.master_map_id)]),g.from("operations").select("*").eq("master_map_id",a.master_map_id)]),x=A.data,[$,ee,J]=Y,T=Z.data;if(console.log("Map data loaded:",x?.id),!x)return{profile:a,subscription:f,connected_map:null};const[te,se,oe]=await Promise.all([g.from("profiles").select("full_name").eq("id",x.master_user_id).single(),g.from("user_subscriptions").select("*").eq("user_id",x.master_user_id).single(),g.from("vehicle_state").select("*").eq("master_map_id",a.master_map_id).in("vehicle_id",J.data?.map(z=>z.id)||[])]),D={id:x.id,map_name:x.map_name,master_user_id:x.master_user_id,owner:te.data?.full_name||"Unknown",is_owner:o===x.master_user_id},L={marker_count:$.count||0,trail_count:ee.count||0,connected_profiles:J.data||[],vehicle_states:oe.data||[]},W=se.data;if(Se.set({id:D.id,map_name:D.map_name,master_user_id:D.master_user_id,owner:D.owner,is_owner:D.is_owner,masterSubscription:W||null,is_connected:!0}),we.set({marker_count:L.marker_count,trail_count:L.trail_count,connected_profiles:L.connected_profiles,vehicle_states:L.vehicle_states}),T?.length){Pe.set(T);const z=T.find(re=>re.id===a.selected_operation_id);z&&Ce.set(z)}return{profile:a,subscription:f,connected_map:D,map_activity:L,master_subscription:W,operations:T}}catch(l){return console.error("Error loading user data:",l),s(1,m=l),null}}async function b(o,l,h){if(!o)return;const a={select_role:"/account/select_role",join_map:"/account/join_map",onboard_manager:"/account/onboard_manager",payment_plans:"/account/payment_plans",user_survey:"/account/user_survey",select_plan:"/account/select_plan"};if(!Object.values(a).some(A=>r.url.pathname===A||r.url.pathname.startsWith(A))){if(!o.role){S(a.select_role);return}if(!o.onboarded){if(o.role==="operator"){if(!l){S(a.join_map);return}}else if(o.role==="manager"){if(!h){S(a.payment_plans);return}S(a.onboard_manager);return}}}}function E(o,l){console.log("Auth State Change:",{event:o,hasSession:!!l,userId:l?.user?.id}),o==="SIGNED_OUT"&&!_&&(_=!0,S("/login"))}async function q(){try{if(!e?.user?.id){console.log("No valid session, redirecting to login"),_=!0,S("/login");return}const o=await j();O=!0,console.log("Loaded User Data:",o),o&&await b(o.profile,o.connected_map,o.subscription),console.log("Data loading complete")}catch(o){console.error("Data loading error:",o),s(1,m=o)}finally{s(0,n=!1)}}async function I(){if(c.sessionPromise)try{if(!(await c.sessionPromise).isAuthenticated){console.log("Session not authenticated, redirecting to login"),_=!0,S("/login");return}await q()}catch(o){console.error("Error processing session:",o),s(1,m=o),s(0,n=!1)}else c.sessionStatus==="error"&&s(0,n=!1)}Q(()=>{console.log("Account layout mounted"),c.sessionPromise?I():e?.user?.id?q():n||(_=!0,S("/login"));const{data:o}=g.auth.onAuthStateChange(E);return p=o.subscription.unsubscribe,()=>{console.log("Account layout unmounting"),p&&p()}}),Q(()=>{if(e?.user?.id){const l=document.cookie.split(";").reduce((h,a)=>{const[f,A]=a.trim().split("=");return h[f]=A,h},{}).pending_map_id;l&&(console.log("Found pending map cookie:",l),document.cookie="pending_map_id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",g.from("profiles").update({master_map_id:l}).eq("id",e.user.id).then(({error:h})=>{h||(window.location.href="/account")}))}});const v=()=>window.location.reload();return i.$$set=o=>{"data"in o&&s(2,c=o.data),"$$scope"in o&&s(3,d=o.$$scope)},[n,m,c,d,u,v]}class Ke extends ge{constructor(t){super(),he(this,t,Ee,Oe,ie,{data:2})}}export{Ke as component,We as universal};

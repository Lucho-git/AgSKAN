import{s as H,n as P,d as h,b as w,i as y,a as B,A as K,c as v,e as L,f as S,j as N,k as $,l as M,z as G,g as O,x as q,w as ee,y as te}from"../chunks/scheduler.BVGjjnGO.js";import{S as W,i as j,t as C,a as I,e as se,d as T,m as D,c as V,b as A,g as ie}from"../chunks/index.Vv2yv23T.js";import{S as U}from"../chunks/settings_module.Cvn9yWrB.js";import{d as ne,P as oe,e as re}from"../chunks/index.B9zg-xLz.js";import{s as ae,a as le}from"../chunks/sessionStore.rIZpZ3yf.js";import{p as z}from"../chunks/profileStore.DorDk9Q6.js";import{g as ce}from"../chunks/entry.CJi6DTPP.js";import{p as ue}from"../chunks/stores.6DhR_UaX.js";import{s as F}from"../chunks/supabaseClient.CEfSaNHh.js";import{t as R}from"../chunks/Toaster.svelte_svelte_type_style_lang.BcvbULy5.js";function J(){const o=navigator.userAgent,e=window.screen.width,t=window.screen.height;return/Android/i.test(o)?e<600?"Android Phone":"Android Tablet":/iPad|iPhone|iPod/.test(o)&&!window.MSStream?/iPad/.test(o)||Math.max(e,t)>1e3?"iOS Tablet":"iPhone":/Windows|Macintosh|Linux/.test(o)?"Desktop":"Unknown"}async function X(){return new Promise((o,e)=>{console.log("Starting getOrCreateDeviceId...");const t="SKANStarterDB",s="deviceInfo",r=indexedDB.open(t,1);r.onerror=n=>{console.error("IndexedDB error:",n),e("IndexedDB error")},r.onsuccess=n=>{console.log("IndexedDB opened successfully");const u=n.target.result.transaction([s],"readwrite").objectStore(s),l=u.get("deviceId");l.onsuccess=()=>{let f;l.result?(console.log("Existing deviceId found:",l.result),typeof l.result=="object"&&l.result.id&&l.result.type?f=l.result:(f={id:typeof l.result=="object"?l.result.id:l.result,type:J()},u.put(f,"deviceId"))):(console.log("No existing deviceId, creating new one"),f={id:crypto.randomUUID(),type:J()},u.put(f,"deviceId")),console.log("DeviceInfo:",f),o(f)},l.onerror=f=>{console.error("Error getting deviceId:",f),e("Error getting deviceId")}},r.onupgradeneeded=n=>{console.log("Upgrading or creating IndexedDB"),n.target.result.createObjectStore(s)}})}async function Q(o){if(console.log("Starting subscribeToPushNotifications for user:",o),"serviceWorker"in navigator&&"PushManager"in window)try{const e=await X();console.log("Device info:",e);const t=await navigator.serviceWorker.ready;console.log("Service Worker is ready");const s=new Uint8Array(JSON.parse(ne));console.log("Application Server Key:",s);const r=await t.pushManager.getSubscription();let n;if(r){console.log("Existing subscription found:",r);const u=new Uint8Array(r.options.applicationServerKey);fe(u,s)?(console.log("Existing subscription is valid, reusing"),n=r):(console.log("Existing subscription uses different key, unsubscribing..."),await r.unsubscribe(),console.log("Unsubscribed from existing subscription"),n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s}),console.log("New subscription created:",n))}else console.log("No existing subscription found"),n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s}),console.log("New subscription created:",n);console.log("Saving subscription to database...");const{data:a,error:d}=await F.from("push_subscriptions").upsert({user_id:o,device_id:e.id,device_type:e.type,subscription:JSON.stringify(n)},{onConflict:"user_id, device_id"});if(d)throw console.error("Error saving subscription to database:",d),new Error(`Failed to save subscription: ${d.message}`);return console.log("Subscription saved successfully:",a),{success:!0}}catch(e){return console.error("Error subscribing to push notifications:",e),{success:!1,error:e.message}}else return console.log("Push notifications not supported"),{success:!1,error:"Push notifications not supported"}}function fe(o,e){if(o.byteLength!==e.byteLength)return!1;const t=new Int8Array(o),s=new Int8Array(e);for(let r=0;r!==o.byteLength;r++)if(t[r]!==s[r])return!1;return!0}async function de(o,e,t){console.log("Sending push notification...",o,e,t);try{const s=await fetch("https://hmxxqacnzxqpcheoeidn.supabase.co/functions/v1/send-notification",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${oe}`},body:JSON.stringify({subscription:o,title:e,body:t})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to send push notification")}const r=await s.json();return console.log("Push notification sent successfully:",r),{success:!0,...r}}catch(s){return console.error("Error sending push notification:",s),{success:!1,error:s.message}}}function Y(o){let e,t,s,r="Chat",n;function a(l,f){return l[1]!=="granted"?ge:pe}let d=a(o),u=d(o);return{c(){e=N("div"),t=N("div"),s=N("h3"),s.textContent=r,n=$(),u.c(),this.h()},l(l){e=v(l,"DIV",{class:!0});var f=L(e);t=v(f,"DIV",{class:!0});var p=L(t);s=v(p,"H3",{class:!0,"data-svelte-h":!0}),O(s)!=="svelte-1ezxekg"&&(s.textContent=r),n=S(p),u.l(p),p.forEach(h),f.forEach(h),this.h()},h(){w(s,"class","card-title"),w(t,"class","card-body"),w(e,"class","card w-80 bg-base-100 shadow-xl mb-4")},m(l,f){y(l,e,f),B(e,t),B(t,s),B(t,n),u.m(t,null)},p(l,f){d===(d=a(l))&&u?u.p(l,f):(u.d(1),u=d(l),u&&(u.c(),u.m(t,null)))},d(l){l&&h(e),u.d()}}}function pe(o){let e,t="Test Push Notification",s,r;return{c(){e=N("button"),e.textContent=t,this.h()},l(n){e=v(n,"BUTTON",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-9luf4i"&&(e.textContent=t),this.h()},h(){w(e,"class","btn btn-secondary")},m(n,a){y(n,e,a),s||(r=K(e,"click",o[4]),s=!0)},p:P,d(n){n&&h(e),s=!1,r()}}}function ge(o){let e,t="Enable Notifications",s,r;return{c(){e=N("button"),e.textContent=t,this.h()},l(n){e=v(n,"BUTTON",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-abvrqe"&&(e.textContent=t),this.h()},h(){w(e,"class","btn btn-primary")},m(n,a){y(n,e,a),s||(r=K(e,"click",o[3]),s=!0)},p:P,d(n){n&&h(e),s=!1,r()}}}function me(o){let e,t,s,r,n,a,d,u=o[0]&&Y(o);return{c(){e=N("div"),u&&u.c(),t=$(),s=N("button"),r=N("i"),this.h()},l(l){e=v(l,"DIV",{class:!0});var f=L(e);u&&u.l(f),t=S(f),s=v(f,"BUTTON",{class:!0});var p=L(s);r=v(p,"I",{class:!0}),L(r).forEach(h),p.forEach(h),f.forEach(h),this.h()},h(){w(r,"class",n=o[0]?"at-bell-minus":"at-bell-plus"),w(s,"class","btn btn-circle btn-lg btn-primary"),w(e,"class","fixed bottom-8 right-8 z-50 flex flex-col items-end")},m(l,f){y(l,e,f),u&&u.m(e,null),B(e,t),B(e,s),B(s,r),a||(d=K(s,"click",o[2]),a=!0)},p(l,[f]){l[0]?u?u.p(l,f):(u=Y(l),u.c(),u.m(e,t)):u&&(u.d(1),u=null),f&1&&n!==(n=l[0]?"at-bell-minus":"at-bell-plus")&&w(r,"class",n)},i:P,o:P,d(l){l&&h(e),u&&u.d(),a=!1,d()}}}function be(o,e,t){let s;M(o,ue,p=>t(6,s=p));let r=!1,n="default",a;G(async()=>{t(1,n=Notification.permission);const p=s.data.session;p&&(a=p.user.id)});function d(){t(0,r=!r),r&&u()}async function u(){if(console.log("Checking and updating subscription..."),console.log("Notification permission:",Notification.permission),console.log("User ID:",a),Notification.permission==="granted"&&a){console.log("Getting/Creating device id...");const p=await X();console.log("Device Info:",p);const{data:c,error:g}=await F.from("push_subscriptions").select("subscription").eq("user_id",a).eq("device_id",p.id).single();if(!c||g){console.log("No existing subscription found. Creating new subscription...");const m=await Q(a);console.log("Subscription result:",m),m.success?(t(1,n="granted"),console.log("New subscription created successfully")):console.error("Failed to create new subscription:",m.error)}else console.log("Existing subscription found. No update needed.")}else console.log("Notification permission not granted or user ID not available")}async function l(){const p=new Promise(async(c,g)=>{try{console.log("Current notification permission:",Notification.permission),console.log("Current user ID:",a);const m=await Notification.requestPermission();if(console.log("Requested permission result:",m),t(1,n=m),m!=="granted")console.log("Notification permission not granted"),g(new Error("Notification permission not granted"));else if(!a)console.log("User ID not available"),g(new Error("User ID not available"));else{console.log("Attempting to subscribe to push notifications");const i=await Q(a);console.log("Subscription result:",i),i.success?c("Notifications enabled successfully!"):g(new Error(i.error||"Failed to enable notifications"))}}catch(m){console.error("Error in enableNotifications:",m),g(m)}});R.promise(p,{loading:"Enabling notifications...",success:c=>c,error:c=>`Error: ${c.message}`})}async function f(){const p=new Promise(async(c,g)=>{try{const{data:m,error:i}=await F.from("push_subscriptions").select("subscription, device_type").eq("user_id",a);if(i)throw i;if(m&&m.length>0){const _=(await Promise.all(m.map(async E=>{const Z=JSON.parse(E.subscription);return{...await de(Z,"Test Notification","Hi !"),deviceType:E.device_type}}))).filter(E=>E.success),k=_.length,x=_.map(E=>E.deviceType).join(", ");k>0?c(`Test notifications sent successfully to ${k} device(s)!
Devices: ${x}`):g(new Error("Failed to send notifications to any devices"))}else g(new Error("No subscriptions found for this user"))}catch(m){g(m)}});R.promise(p,{loading:"Sending test notifications...",success:c=>c,error:c=>`Error: ${c.message}`})}return[r,n,d,l,f]}class he extends W{constructor(e){super(),j(this,e,be,me,H,{})}}function _e(o){let e;return{c(){e=q()},l(t){e=q()},m(t,s){y(t,e,s)},p(t,[s]){},i:P,o:P,d(t){t&&h(e)}}}function ye(o,e,t){let s=!1,{data:r}=e;const n=()=>{t(0,s=!0),R.success("Test Button Pressed",{description:"This is a developer testing feature",duration:3e3}),setTimeout(()=>{t(0,s=!1)},1e3)};return o.$$set=a=>{"data"in a&&t(2,r=a.data)},[s,n,r]}class we extends W{constructor(e){super(),j(this,e,ye,_e,H,{data:2})}}function ve(o){let e,t,s,r,n,a,d,u,l,f,p,c,g,m;return e=new U({props:{title:"Profile",editable:!1,fields:[{id:"fullName",label:"Name",initialValue:o[8]?.full_name??""},{id:"companyName",label:"Company Name",initialValue:o[8]?.company_name??""},{id:"website",label:"Company Website",initialValue:o[8]?.website??""}],$$slots:{buttons:[Se]},$$scope:{ctx:o}}}),s=new U({props:{title:"Email",editable:!1,fields:[{id:"email",initialValue:o[7]?.user?.email||""}],editButtonTitle:"Change Email",editLink:"/account/settings/change_email"}}),n=new U({props:{title:"Password",editable:!1,fields:[{id:"password",initialValue:"••••••••••••••••"}],editButtonTitle:"Change Password",editLink:"/account/settings/change_password"}}),d=new U({props:{title:"Subscription",editable:!1,fields:[{id:"planName",label:"Current Plan",initialValue:o[4]},{id:"planStatus",label:"Status",initialValue:o[2]},{id:"quantity",label:"Quantity",initialValue:o[3]}],editButtonTitle:o[6],editLink:o[5]}}),l=new U({props:{title:"App Version",editable:!1,dangerous:!0,fields:[{id:"version",initialValue:o[9]}],editButtonTitle:"Delete Account",editLink:"/account/settings/delete_account"}}),p=new he({}),g=new we({props:{data:{session:o[7],profile:o[8],subscriptionData:o[1]}}}),{c(){A(e.$$.fragment),t=$(),A(s.$$.fragment),r=$(),A(n.$$.fragment),a=$(),A(d.$$.fragment),u=$(),A(l.$$.fragment),f=$(),A(p.$$.fragment),c=$(),A(g.$$.fragment)},l(i){V(e.$$.fragment,i),t=S(i),V(s.$$.fragment,i),r=S(i),V(n.$$.fragment,i),a=S(i),V(d.$$.fragment,i),u=S(i),V(l.$$.fragment,i),f=S(i),V(p.$$.fragment,i),c=S(i),V(g.$$.fragment,i)},m(i,b){D(e,i,b),y(i,t,b),D(s,i,b),y(i,r,b),D(n,i,b),y(i,a,b),D(d,i,b),y(i,u,b),D(l,i,b),y(i,f,b),D(p,i,b),y(i,c,b),D(g,i,b),m=!0},p(i,b){const _={};b&256&&(_.fields=[{id:"fullName",label:"Name",initialValue:i[8]?.full_name??""},{id:"companyName",label:"Company Name",initialValue:i[8]?.company_name??""},{id:"website",label:"Company Website",initialValue:i[8]?.website??""}]),b&32768&&(_.$$scope={dirty:b,ctx:i}),e.$set(_);const k={};b&128&&(k.fields=[{id:"email",initialValue:i[7]?.user?.email||""}]),s.$set(k);const x={};b&28&&(x.fields=[{id:"planName",label:"Current Plan",initialValue:i[4]},{id:"planStatus",label:"Status",initialValue:i[2]},{id:"quantity",label:"Quantity",initialValue:i[3]}]),b&64&&(x.editButtonTitle=i[6]),b&32&&(x.editLink=i[5]),d.$set(x);const E={};b&386&&(E.data={session:i[7],profile:i[8],subscriptionData:i[1]}),g.$set(E)},i(i){m||(I(e.$$.fragment,i),I(s.$$.fragment,i),I(n.$$.fragment,i),I(d.$$.fragment,i),I(l.$$.fragment,i),I(p.$$.fragment,i),I(g.$$.fragment,i),m=!0)},o(i){C(e.$$.fragment,i),C(s.$$.fragment,i),C(n.$$.fragment,i),C(d.$$.fragment,i),C(l.$$.fragment,i),C(p.$$.fragment,i),C(g.$$.fragment,i),m=!1},d(i){i&&(h(t),h(r),h(a),h(u),h(f),h(c)),T(e,i),T(s,i),T(n,i),T(d,i),T(l,i),T(p,i),T(g,i)}}}function Ne(o){let e,t='<div class="loading loading-spinner loading-lg"></div>';return{c(){e=N("div"),e.innerHTML=t,this.h()},l(s){e=v(s,"DIV",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-asr66p"&&(e.innerHTML=t),this.h()},h(){w(e,"class","flex h-64 items-center justify-center")},m(s,r){y(s,e,r)},p:P,i:P,o:P,d(s){s&&h(e)}}}function Se(o){let e,t='<a href="/account/settings/edit_profile"><button class="btn btn-outline btn-sm min-w-[145px]">Edit Profile</button></a> <a href="/account/sign_out"><button class="btn btn-outline btn-error btn-sm min-w-[145px]">Sign Out</button></a>';return{c(){e=N("div"),e.innerHTML=t,this.h()},l(s){e=v(s,"DIV",{class:!0,slot:!0,"data-svelte-h":!0}),O(e)!=="svelte-g8yf64"&&(e.innerHTML=t),this.h()},h(){w(e,"class","flex flex-col gap-2"),w(e,"slot","buttons")},m(s,r){y(s,e,r)},p:P,d(s){s&&h(e)}}}function $e(o){let e,t,s="Settings",r,n,a,d,u;const l=[Ne,ve],f=[];function p(c,g){return c[0]?0:1}return n=p(o),a=f[n]=l[n](o),{c(){e=$(),t=N("h1"),t.textContent=s,r=$(),a.c(),d=q(),this.h()},l(c){ee("svelte-hosjka",document.head).forEach(h),e=S(c),t=v(c,"H1",{class:!0,"data-svelte-h":!0}),O(t)!=="svelte-mlvd3d"&&(t.textContent=s),r=S(c),a.l(c),d=q(),this.h()},h(){document.title="Settings",w(t,"class","mb-6 text-2xl font-bold")},m(c,g){y(c,e,g),y(c,t,g),y(c,r,g),f[n].m(c,g),y(c,d,g),u=!0},p(c,[g]){let m=n;n=p(c),n===m?f[n].p(c,g):(ie(),C(f[m],1,1,()=>{f[m]=null}),se(),a=f[n],a?a.p(c,g):(a=f[n]=l[n](c),a.c()),I(a,1),a.m(d.parentNode,d))},i(c){u||(I(a),u=!0)},o(c){C(a),u=!1},d(c){c&&(h(e),h(t),h(r),h(d)),f[n].d(c)}}}function Pe(o,e,t){let s,r,n,a,d;M(o,ae,_=>t(7,a=_)),M(o,z,_=>t(8,d=_)),te("adminSection").set("settings");let l=!0,f=null;const p=re;let c="FREE",g="Active",m="1",i=!1;async function b(){try{const{data:_,error:k}=await le.from("user_subscriptions").select("*").eq("user_id",a.user.id).single();_&&!k&&(t(1,f=_),t(10,c=_.subscription||"FREE"),t(11,i=c!=="FREE"),t(2,g="Active"),t(3,m=_.current_seats?.toString()||"1"))}catch(_){console.error("Error fetching subscription:",_)}}return G(async()=>{if(!a){ce("/login");return}(!d||!d.id)&&await z.loadProfile(a.user.id),await b(),t(0,l=!1)}),o.$$.update=()=>{o.$$.dirty&2048&&t(6,s=i?"Manage Subscription":"Upgrade Plan"),o.$$.dirty&1024&&t(4,n=c==="FREE"?"Free Plan":c.charAt(0)+c.slice(1).toLowerCase()+" Plan")},t(5,r="/account/billing"),[l,f,g,m,n,r,s,a,d,p,c,i]}class Ue extends W{constructor(e){super(),j(this,e,Pe,$e,H,{})}}export{Ue as component};

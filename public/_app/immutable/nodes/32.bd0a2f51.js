import{s as ue,a as T,w as ne,x as de,d as c,f as x,j as ee,n as ie,z as fe,e as f,t as p,c as h,b as v,g as ae,h as _,i as H,k as e,q as N}from"../chunks/scheduler.78aa6f0d.js";import{S as pe,i as he}from"../chunks/index.9a12d9f3.js";import{g as _e}from"../chunks/navigation.dd464073.js";import{a as $,s as ce}from"../chunks/sessionStore.4d48270f.js";function ge(g){let i,r,d,y="Authentication Error",t,s,o,a,u,E="Return to login",n,l,b,w,I=(g[2].hash||"none")+"",O,B,U,V,M=(g[2].query||"none")+"",L,J,j,F,G=(g[2].sessionResult||"pending")+"",Q,K,Y,z,W=g[2].profileCreated?"Yes":"No",D,X,m,S,q=(g[2].redirectTo||"default")+"",C;return{c(){i=f("div"),r=f("div"),d=f("h2"),d.textContent=y,t=T(),s=f("p"),o=p(g[1]),a=T(),u=f("a"),u.textContent=E,n=T(),l=f("div"),b=f("p"),w=p("Hash: "),O=p(I),B=T(),U=f("p"),V=p("Query: "),L=p(M),J=T(),j=f("p"),F=p("Session Result: "),Q=p(G),K=T(),Y=f("p"),z=p("Profile Created/Updated: "),D=p(W),X=T(),m=f("p"),S=p("Redirect To: "),C=p(q),this.h()},l(P){i=h(P,"DIV",{class:!0});var R=v(i);r=h(R,"DIV",{class:!0});var A=v(r);d=h(A,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-bznbjw"&&(d.textContent=y),t=x(A),s=h(A,"P",{class:!0});var Z=v(s);o=_(Z,g[1]),Z.forEach(c),a=x(A),u=h(A,"A",{href:!0,class:!0,"data-svelte-h":!0}),ae(u)!=="svelte-1m5fy2z"&&(u.textContent=E),n=x(A),l=h(A,"DIV",{class:!0});var k=v(l);b=h(k,"P",{});var te=v(b);w=_(te,"Hash: "),O=_(te,I),te.forEach(c),B=x(k),U=h(k,"P",{});var re=v(U);V=_(re,"Query: "),L=_(re,M),re.forEach(c),J=x(k),j=h(k,"P",{});var oe=v(j);F=_(oe,"Session Result: "),Q=_(oe,G),oe.forEach(c),K=x(k),Y=h(k,"P",{});var se=v(Y);z=_(se,"Profile Created/Updated: "),D=_(se,W),se.forEach(c),X=x(k),m=h(k,"P",{});var le=v(m);S=_(le,"Redirect To: "),C=_(le,q),le.forEach(c),k.forEach(c),A.forEach(c),R.forEach(c),this.h()},h(){H(d,"class","mb-4 text-xl font-semibold"),H(s,"class","text-red-500"),H(u,"href","/login"),H(u,"class","mt-4 inline-block rounded bg-blue-500 px-4 py-2 text-white"),H(l,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),H(r,"class","text-center"),H(i,"class","flex h-screen items-center justify-center")},m(P,R){ee(P,i,R),e(i,r),e(r,d),e(r,t),e(r,s),e(s,o),e(r,a),e(r,u),e(r,n),e(r,l),e(l,b),e(b,w),e(b,O),e(l,B),e(l,U),e(U,V),e(U,L),e(l,J),e(l,j),e(j,F),e(j,Q),e(l,K),e(l,Y),e(Y,z),e(Y,D),e(l,X),e(l,m),e(m,S),e(m,C)},p(P,R){R&2&&N(o,P[1]),R&4&&I!==(I=(P[2].hash||"none")+"")&&N(O,I),R&4&&M!==(M=(P[2].query||"none")+"")&&N(L,M),R&4&&G!==(G=(P[2].sessionResult||"pending")+"")&&N(Q,G),R&4&&W!==(W=P[2].profileCreated?"Yes":"No")&&N(D,W),R&4&&q!==(q=(P[2].redirectTo||"default")+"")&&N(C,q)},d(P){P&&c(i)}}}function me(g){let i,r,d,y="Completing authentication...",t,s,o,a,u,E,n=(g[2].hash||"none")+"",l,b,w,I,O=(g[2].query||"none")+"",B,U,V,M,L=(g[2].sessionResult||"pending")+"",J,j,F,G,Q=g[2].profileCreated?"Yes":"No",K,Y,z,W,D=(g[2].redirectTo||"default")+"",X;return{c(){i=f("div"),r=f("div"),d=f("h2"),d.textContent=y,t=T(),s=f("div"),o=T(),a=f("div"),u=f("p"),E=p("Hash: "),l=p(n),b=T(),w=f("p"),I=p("Query: "),B=p(O),U=T(),V=f("p"),M=p("Session Result: "),J=p(L),j=T(),F=f("p"),G=p("Profile Created/Updated: "),K=p(Q),Y=T(),z=f("p"),W=p("Redirect To: "),X=p(D),this.h()},l(m){i=h(m,"DIV",{class:!0});var S=v(i);r=h(S,"DIV",{class:!0});var q=v(r);d=h(q,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-lpwua0"&&(d.textContent=y),t=x(q),s=h(q,"DIV",{class:!0}),v(s).forEach(c),o=x(q),a=h(q,"DIV",{class:!0});var C=v(a);u=h(C,"P",{});var P=v(u);E=_(P,"Hash: "),l=_(P,n),P.forEach(c),b=x(C),w=h(C,"P",{});var R=v(w);I=_(R,"Query: "),B=_(R,O),R.forEach(c),U=x(C),V=h(C,"P",{});var A=v(V);M=_(A,"Session Result: "),J=_(A,L),A.forEach(c),j=x(C),F=h(C,"P",{});var Z=v(F);G=_(Z,"Profile Created/Updated: "),K=_(Z,Q),Z.forEach(c),Y=x(C),z=h(C,"P",{});var k=v(z);W=_(k,"Redirect To: "),X=_(k,D),k.forEach(c),C.forEach(c),q.forEach(c),S.forEach(c),this.h()},h(){H(d,"class","mb-4 text-xl font-semibold"),H(s,"class","mx-auto h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"),H(a,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),H(r,"class","text-center"),H(i,"class","flex h-screen items-center justify-center")},m(m,S){ee(m,i,S),e(i,r),e(r,d),e(r,t),e(r,s),e(r,o),e(r,a),e(a,u),e(u,E),e(u,l),e(a,b),e(a,w),e(w,I),e(w,B),e(a,U),e(a,V),e(V,M),e(V,J),e(a,j),e(a,F),e(F,G),e(F,K),e(a,Y),e(a,z),e(z,W),e(z,X)},p(m,S){S&4&&n!==(n=(m[2].hash||"none")+"")&&N(l,n),S&4&&O!==(O=(m[2].query||"none")+"")&&N(B,O),S&4&&L!==(L=(m[2].sessionResult||"pending")+"")&&N(J,L),S&4&&Q!==(Q=m[2].profileCreated?"Yes":"No")&&N(K,Q),S&4&&D!==(D=(m[2].redirectTo||"default")+"")&&N(X,D)},d(m){m&&c(i)}}}function ve(g){let i,r;function d(s,o){if(s[0])return me;if(s[1])return ge}let y=d(g),t=y&&y(g);return{c(){i=T(),t&&t.c(),r=ne(),this.h()},l(s){de("svelte-1ey0ckx",document.head).forEach(c),i=x(s),t&&t.l(s),r=ne(),this.h()},h(){document.title="Authentication"},m(s,o){ee(s,i,o),t&&t.m(s,o),ee(s,r,o)},p(s,[o]){y===(y=d(s))&&t?t.p(s,o):(t&&t.d(1),t=y&&y(s),t&&(t.c(),t.m(r.parentNode,r)))},i:ie,o:ie,d(s){s&&(c(i),c(r)),t&&t.d(s)}}}function Ee(g,i,r){let d=!0,y=null,t={hash:"",query:"",sessionResult:null,profileCreated:!1,redirectTo:""};async function s(o){var a,u,E;try{console.log("Creating or updating profile for user:",o.user.id);const n={id:o.user.id,email:o.user.email,full_name:((a=o.user.user_metadata)==null?void 0:a.full_name)||null,avatar_url:((u=o.user.user_metadata)==null?void 0:u.avatar_url)||null,updated_at:new Date().toISOString(),onboarded:!1,last_sign_in:new Date().toISOString(),provider:((E=o.user.app_metadata)==null?void 0:E.provider)||"email"};console.log("User data prepared:",n);const{data:l,error:b}=await $.from("profiles").select("id, created_at, email").eq("id",o.user.id).single();if(b&&b.code!=="PGRST116")return console.error("Error checking existing profile:",b),!1;if(l){console.log("Existing profile found, updating:",l);const{error:w}=await $.from("profiles").update({last_sign_in:n.last_sign_in,updated_at:n.updated_at,...l.email?{}:{email:n.email},...l.full_name?{}:{full_name:n.full_name},...l.avatar_url?{}:{avatar_url:n.avatar_url}}).eq("id",o.user.id);return w?(console.error("Error updating profile:",w),!1):(console.log("Profile updated successfully"),!0)}else{console.log("No existing profile found, creating new profile");const{error:w}=await $.from("profiles").insert({...n,created_at:new Date().toISOString()});if(w&&w.code!=="23505")return console.error("Error creating profile:",w),!1;{console.log("Profile created successfully for user:",o.user.id);const{error:I}=await $.from("user_subscriptions").insert({user_id:o.user.id,subscription:"FREE",marker_limit:100,trail_limit:1e5,current_seats:1,updated_at:new Date().toISOString(),created_at:new Date().toISOString()});return I&&I.code!=="23505"?console.error("Error creating subscription:",I):console.log("Free subscription created for user:",o.user.id),!0}}}catch(n){return console.error("Error in profile creation/update:",n),!1}}return fe(async()=>{console.log("Auth callback mounting - PROFILE CREATION WILL HAPPEN HERE");try{r(2,t.hash=window.location.hash,t),r(2,t.query=window.location.search,t);const o=new URLSearchParams(window.location.hash.substring(1)),a=new URLSearchParams(window.location.search);r(2,t.redirectTo=a.get("next")||"/account",t),console.log("Auth callback parameters:",{hash:o.toString(),query:a.toString(),redirectTo:t.redirectTo});let u=null;if(window.location.hash){console.log("Processing hash fragment");const E=o.get("access_token"),n=o.get("refresh_token");if(E&&n){console.log("Setting session from tokens");const{data:l,error:b}=await $.auth.setSession({access_token:E,refresh_token:n});if(b)throw b;u=l.session,l.session&&(console.log("Manually updating session store"),ce.set(l.session),r(2,t.profileCreated=await s(l.session),t),console.log("Profile creation result:",t.profileCreated))}}else if(a.get("type")==="recovery"||a.get("type")==="signup"){console.log("Processing code exchange");const{data:E,error:n}=await $.auth.exchangeCodeForSession(a.get("code"));if(n)throw n;u=E.session,E.session&&(console.log("Manually updating session store from code exchange"),ce.set(E.session),r(2,t.profileCreated=await s(E.session),t),console.log("Profile creation result:",t.profileCreated))}r(2,t.sessionResult=u?"success":"failure",t),console.log("Auth process complete, redirecting to:",t.redirectTo),setTimeout(()=>{_e(t.redirectTo)},1e3)}catch(o){console.error("Error during auth callback:",o),r(1,y=o.message),r(2,t.sessionResult="error: "+o.message,t),r(0,d=!1)}}),[d,y,t]}class Ce extends pe{constructor(i){super(),he(this,i,Ee,ve,ue,{})}}export{Ce as component};

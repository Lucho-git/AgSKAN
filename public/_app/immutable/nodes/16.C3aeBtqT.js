import{s as J,n as C,d as b,b as v,i as _,a as x,w as Y,c as w,e as q,f as I,j as $,k as V,l as K,v as fe,g as M,z as W,r as pe,A as me}from"../chunks/DjMlahvE.js";import{S as G,i as X,t as k,a as E,e as ge,d as D,m as A,c as B,b as O,g as be}from"../chunks/KhAD1Hhl.js";import{S as L}from"../chunks/Cel9KQlU.js";import{d as he,a as _e,e as ye}from"../chunks/fQFbg8Ms.js";import{s as ve,a as we}from"../chunks/DSS83BMa.js";import{p as ae}from"../chunks/C1kVPyTF.js";import{g as $e}from"../chunks/BEF5l8Zs.js";import{p as Se}from"../chunks/1ZeRG0_x.js";import{s as j}from"../chunks/BaPH9Oqq.js";import{t as z}from"../chunks/C31GE7Pe.js";import{C as Q}from"../chunks/DU-NpqEO.js";function le(){const n=navigator.userAgent,e=window.screen.width,s=window.screen.height;return/Android/i.test(n)?e<600?"Android Phone":"Android Tablet":/iPad|iPhone|iPod/.test(n)&&!window.MSStream?/iPad/.test(n)||Math.max(e,s)>1e3?"iOS Tablet":"iPhone":/Windows|Macintosh|Linux/.test(n)?"Desktop":"Unknown"}async function de(){return new Promise((n,e)=>{console.log("Starting getOrCreateDeviceId...");const s="SKANStarterDB",t="deviceInfo",o=indexedDB.open(s,1);o.onerror=i=>{console.error("IndexedDB error:",i),e("IndexedDB error")},o.onsuccess=i=>{console.log("IndexedDB opened successfully");const l=i.target.result.transaction([t],"readwrite").objectStore(t),u=l.get("deviceId");u.onsuccess=()=>{let c;u.result?(console.log("Existing deviceId found:",u.result),typeof u.result=="object"&&u.result.id&&u.result.type?c=u.result:(c={id:typeof u.result=="object"?u.result.id:u.result,type:le()},l.put(c,"deviceId"))):(console.log("No existing deviceId, creating new one"),c={id:crypto.randomUUID(),type:le()},l.put(c,"deviceId")),console.log("DeviceInfo:",c),n(c)},u.onerror=c=>{console.error("Error getting deviceId:",c),e("Error getting deviceId")}},o.onupgradeneeded=i=>{console.log("Upgrading or creating IndexedDB"),i.target.result.createObjectStore(t)}})}async function ce(n){if(console.log("Starting subscribeToPushNotifications for user:",n),"serviceWorker"in navigator&&"PushManager"in window)try{const e=await de();console.log("Device info:",e);const s=await navigator.serviceWorker.ready;console.log("Service Worker is ready");const t=new Uint8Array(JSON.parse(he));console.log("Application Server Key:",t);const o=await s.pushManager.getSubscription();let i;if(o){console.log("Existing subscription found:",o);const l=new Uint8Array(o.options.applicationServerKey);Ne(l,t)?(console.log("Existing subscription is valid, reusing"),i=o):(console.log("Existing subscription uses different key, unsubscribing..."),await o.unsubscribe(),console.log("Unsubscribed from existing subscription"),i=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t}),console.log("New subscription created:",i))}else console.log("No existing subscription found"),i=await s.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:t}),console.log("New subscription created:",i);console.log("Saving subscription to database...");const{data:a,error:p}=await j.from("push_subscriptions").upsert({user_id:n,device_id:e.id,device_type:e.type,subscription:JSON.stringify(i)},{onConflict:"user_id, device_id"});if(p)throw console.error("Error saving subscription to database:",p),new Error(`Failed to save subscription: ${p.message}`);return console.log("Subscription saved successfully:",a),{success:!0}}catch(e){return console.error("Error subscribing to push notifications:",e),{success:!1,error:e.message}}else return console.log("Push notifications not supported"),{success:!1,error:"Push notifications not supported"}}function Ne(n,e){if(n.byteLength!==e.byteLength)return!1;const s=new Int8Array(n),t=new Int8Array(e);for(let o=0;o!==n.byteLength;o++)if(s[o]!==t[o])return!1;return!0}async function Pe(n,e,s){console.log("Sending push notification...",n,e,s);try{const t=await fetch("https://hmxxqacnzxqpcheoeidn.supabase.co/functions/v1/send-notification",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${_e}`},body:JSON.stringify({subscription:n,title:e,body:s})});if(!t.ok){const i=await t.json();throw new Error(i.error||"Failed to send push notification")}const o=await t.json();return console.log("Push notification sent successfully:",o),{success:!0,...o}}catch(t){return console.error("Error sending push notification:",t),{success:!1,error:t.message}}}function ue(n){let e,s,t,o="Chat",i;function a(u,c){return u[1]!=="granted"?Ee:ke}let p=a(n),l=p(n);return{c(){e=$("div"),s=$("div"),t=$("h3"),t.textContent=o,i=V(),l.c(),this.h()},l(u){e=w(u,"DIV",{class:!0});var c=q(e);s=w(c,"DIV",{class:!0});var g=q(s);t=w(g,"H3",{class:!0,"data-svelte-h":!0}),M(t)!=="svelte-1ezxekg"&&(t.textContent=o),i=I(g),l.l(g),g.forEach(b),c.forEach(b),this.h()},h(){v(t,"class","card-title"),v(s,"class","card-body"),v(e,"class","card w-80 bg-base-100 shadow-xl mb-4")},m(u,c){_(u,e,c),x(e,s),x(s,t),x(s,i),l.m(s,null)},p(u,c){p===(p=a(u))&&l?l.p(u,c):(l.d(1),l=p(u),l&&(l.c(),l.m(s,null)))},d(u){u&&b(e),l.d()}}}function ke(n){let e,s="Test Push Notification",t,o;return{c(){e=$("button"),e.textContent=s,this.h()},l(i){e=w(i,"BUTTON",{class:!0,"data-svelte-h":!0}),M(e)!=="svelte-9luf4i"&&(e.textContent=s),this.h()},h(){v(e,"class","btn btn-secondary")},m(i,a){_(i,e,a),t||(o=Y(e,"click",n[4]),t=!0)},p:C,d(i){i&&b(e),t=!1,o()}}}function Ee(n){let e,s="Enable Notifications",t,o;return{c(){e=$("button"),e.textContent=s,this.h()},l(i){e=w(i,"BUTTON",{class:!0,"data-svelte-h":!0}),M(e)!=="svelte-abvrqe"&&(e.textContent=s),this.h()},h(){v(e,"class","btn btn-primary")},m(i,a){_(i,e,a),t||(o=Y(e,"click",n[3]),t=!0)},p:C,d(i){i&&b(e),t=!1,o()}}}function Ce(n){let e,s,t,o,i,a,p,l=n[0]&&ue(n);return{c(){e=$("div"),l&&l.c(),s=V(),t=$("button"),o=$("i"),this.h()},l(u){e=w(u,"DIV",{class:!0});var c=q(e);l&&l.l(c),s=I(c),t=w(c,"BUTTON",{class:!0});var g=q(t);o=w(g,"I",{class:!0}),q(o).forEach(b),g.forEach(b),c.forEach(b),this.h()},h(){v(o,"class",i=n[0]?"at-bell-minus":"at-bell-plus"),v(t,"class","btn btn-circle btn-lg btn-primary"),v(e,"class","fixed bottom-8 right-8 z-50 flex flex-col items-end")},m(u,c){_(u,e,c),l&&l.m(e,null),x(e,s),x(e,t),x(t,o),a||(p=Y(t,"click",n[2]),a=!0)},p(u,[c]){u[0]?l?l.p(u,c):(l=ue(u),l.c(),l.m(e,s)):l&&(l.d(1),l=null),c&1&&i!==(i=u[0]?"at-bell-minus":"at-bell-plus")&&v(o,"class",i)},i:C,o:C,d(u){u&&b(e),l&&l.d(),a=!1,p()}}}function Ie(n,e,s){let t;K(n,Se,g=>s(6,t=g));let o=!1,i="default",a;fe(async()=>{s(1,i=Notification.permission);const g=t.data.session;g&&(a=g.user.id)});function p(){s(0,o=!o),o&&l()}async function l(){if(console.log("Checking and updating subscription..."),console.log("Notification permission:",Notification.permission),console.log("User ID:",a),Notification.permission==="granted"&&a){console.log("Getting/Creating device id...");const g=await de();console.log("Device Info:",g);const{data:f,error:d}=await j.from("push_subscriptions").select("subscription").eq("user_id",a).eq("device_id",g.id).single();if(!f||d){console.log("No existing subscription found. Creating new subscription...");const m=await ce(a);console.log("Subscription result:",m),m.success?(s(1,i="granted"),console.log("New subscription created successfully")):console.error("Failed to create new subscription:",m.error)}else console.log("Existing subscription found. No update needed.")}else console.log("Notification permission not granted or user ID not available")}async function u(){const g=new Promise(async(f,d)=>{try{console.log("Current notification permission:",Notification.permission),console.log("Current user ID:",a);const m=await Notification.requestPermission();if(console.log("Requested permission result:",m),s(1,i=m),m!=="granted")console.log("Notification permission not granted"),d(new Error("Notification permission not granted"));else if(!a)console.log("User ID not available"),d(new Error("User ID not available"));else{console.log("Attempting to subscribe to push notifications");const y=await ce(a);console.log("Subscription result:",y),y.success?f("Notifications enabled successfully!"):d(new Error(y.error||"Failed to enable notifications"))}}catch(m){console.error("Error in enableNotifications:",m),d(m)}});z.promise(g,{loading:"Enabling notifications...",success:f=>f,error:f=>`Error: ${f.message}`})}async function c(){const g=new Promise(async(f,d)=>{try{const{data:m,error:y}=await j.from("push_subscriptions").select("subscription, device_type").eq("user_id",a);if(y)throw y;if(m&&m.length>0){const T=(await Promise.all(m.map(async P=>{const F=JSON.parse(P.subscription);return{...await Pe(F,"Test Notification","Hi !"),deviceType:P.device_type}}))).filter(P=>P.success),S=T.length,N=T.map(P=>P.deviceType).join(", ");S>0?f(`Test notifications sent successfully to ${S} device(s)!
Devices: ${N}`):d(new Error("Failed to send notifications to any devices"))}else d(new Error("No subscriptions found for this user"))}catch(m){d(m)}});z.promise(g,{loading:"Sending test notifications...",success:f=>f,error:f=>`Error: ${f.message}`})}return[o,i,p,u,c]}class Ve extends G{constructor(e){super(),X(this,e,Ie,Ce,J,{})}}function Te(n){let e;return{c(){e=W()},l(s){e=W()},m(s,t){_(s,e,t)},p(s,[t]){},i:C,o:C,d(s){s&&b(e)}}}function De(n,e,s){let t=!1,{data:o}=e;const i=()=>{s(0,t=!0),z.success("Test Button Pressed",{description:"This is a developer testing feature",duration:3e3}),setTimeout(()=>{s(0,t=!1)},1e3)};return n.$$set=a=>{"data"in a&&s(2,o=a.data)},[t,i,o]}class Ae extends G{constructor(e){super(),X(this,e,De,Te,J,{data:2})}}function Be(n){var N,P,F,R,Z;let e,s,t,o,i,a,p,l,u,c,g,f,d,m,y;e=new L({props:{title:"Profile",editable:!1,fields:[{id:"fullName",label:"Name",initialValue:((N=n[8])==null?void 0:N.full_name)??""},{id:"companyName",label:"Company Name",initialValue:((P=n[8])==null?void 0:P.company_name)??""},{id:"website",label:"Company Website",initialValue:((F=n[8])==null?void 0:F.website)??""}],$$slots:{buttons:[Ue]},$$scope:{ctx:n}}}),t=new L({props:{title:"Email",editable:!1,fields:[{id:"email",initialValue:((Z=(R=n[7])==null?void 0:R.user)==null?void 0:Z.email)||""}],editButtonTitle:"Change Email",editLink:"/account/settings/change_email"}}),i=new L({props:{title:"Password",editable:!1,fields:[{id:"password",initialValue:"••••••••••••••••"}],editButtonTitle:"Change Password",editLink:"/account/settings/change_password"}});const U=[xe,Le],T=[];function S(r,h){return r[10]?0:1}return p=S(n),l=T[p]=U[p](n),c=new L({props:{title:"App Version",editable:!1,dangerous:!0,fields:[{id:"version",initialValue:n[9]}],editButtonTitle:"Delete Account",editLink:"/account/settings/delete_account"}}),f=new Ve({}),m=new Ae({props:{data:{session:n[7],profile:n[8],subscriptionData:n[1]}}}),{c(){O(e.$$.fragment),s=V(),O(t.$$.fragment),o=V(),O(i.$$.fragment),a=V(),l.c(),u=V(),O(c.$$.fragment),g=V(),O(f.$$.fragment),d=V(),O(m.$$.fragment)},l(r){B(e.$$.fragment,r),s=I(r),B(t.$$.fragment,r),o=I(r),B(i.$$.fragment,r),a=I(r),l.l(r),u=I(r),B(c.$$.fragment,r),g=I(r),B(f.$$.fragment,r),d=I(r),B(m.$$.fragment,r)},m(r,h){A(e,r,h),_(r,s,h),A(t,r,h),_(r,o,h),A(i,r,h),_(r,a,h),T[p].m(r,h),_(r,u,h),A(c,r,h),_(r,g,h),A(f,r,h),_(r,d,h),A(m,r,h),y=!0},p(r,h){var se,ie,ne,oe,re;const H={};h&256&&(H.fields=[{id:"fullName",label:"Name",initialValue:((se=r[8])==null?void 0:se.full_name)??""},{id:"companyName",label:"Company Name",initialValue:((ie=r[8])==null?void 0:ie.company_name)??""},{id:"website",label:"Company Website",initialValue:((ne=r[8])==null?void 0:ne.website)??""}]),h&65536&&(H.$$scope={dirty:h,ctx:r}),e.$set(H);const ee={};h&128&&(ee.fields=[{id:"email",initialValue:((re=(oe=r[7])==null?void 0:oe.user)==null?void 0:re.email)||""}]),t.$set(ee),l.p(r,h);const te={};h&386&&(te.data={session:r[7],profile:r[8],subscriptionData:r[1]}),m.$set(te)},i(r){y||(E(e.$$.fragment,r),E(t.$$.fragment,r),E(i.$$.fragment,r),E(l),E(c.$$.fragment,r),E(f.$$.fragment,r),E(m.$$.fragment,r),y=!0)},o(r){k(e.$$.fragment,r),k(t.$$.fragment,r),k(i.$$.fragment,r),k(l),k(c.$$.fragment,r),k(f.$$.fragment,r),k(m.$$.fragment,r),y=!1},d(r){r&&(b(s),b(o),b(a),b(u),b(g),b(d)),D(e,r),D(t,r),D(i,r),T[p].d(r),D(c,r),D(f,r),D(m,r)}}}function Oe(n){let e,s='<div class="loading loading-spinner loading-lg"></div>';return{c(){e=$("div"),e.innerHTML=s,this.h()},l(t){e=w(t,"DIV",{class:!0,"data-svelte-h":!0}),M(e)!=="svelte-asr66p"&&(e.innerHTML=s),this.h()},h(){v(e,"class","flex h-64 items-center justify-center")},m(t,o){_(t,e,o)},p:C,i:C,o:C,d(t){t&&b(e)}}}function Ue(n){let e,s='<a href="/account/settings/edit_profile"><button class="btn btn-outline btn-sm min-w-[145px]">Edit Profile</button></a> <a href="/account/sign_out"><button class="btn btn-outline btn-error btn-sm min-w-[145px]">Sign Out</button></a>';return{c(){e=$("div"),e.innerHTML=s,this.h()},l(t){e=w(t,"DIV",{class:!0,slot:!0,"data-svelte-h":!0}),M(e)!=="svelte-g8yf64"&&(e.innerHTML=s),this.h()},h(){v(e,"class","flex flex-col gap-2"),v(e,"slot","buttons")},m(t,o){_(t,e,o)},p:C,d(t){t&&b(e)}}}function Le(n){let e,s;return e=new L({props:{title:"Subscription",editable:!1,fields:[{id:"planName",label:"Current Plan",initialValue:n[4]},{id:"planStatus",label:"Status",initialValue:n[2]},{id:"quantity",label:"Quantity",initialValue:n[3]}],editButtonTitle:n[6],editLink:n[5]}}),{c(){O(e.$$.fragment)},l(t){B(e.$$.fragment,t)},m(t,o){A(e,t,o),s=!0},p(t,o){const i={};o&28&&(i.fields=[{id:"planName",label:"Current Plan",initialValue:t[4]},{id:"planStatus",label:"Status",initialValue:t[2]},{id:"quantity",label:"Quantity",initialValue:t[3]}]),o&64&&(i.editButtonTitle=t[6]),o&32&&(i.editLink=t[5]),e.$set(i)},i(t){s||(E(e.$$.fragment,t),s=!0)},o(t){k(e.$$.fragment,t),s=!1},d(t){D(e,t)}}}function xe(n){let e,s;return e=new L({props:{title:"Subscription",editable:!1,fields:[{id:"planName",label:"Current Plan",initialValue:n[4]},{id:"planStatus",label:"Status",initialValue:n[2]},{id:"quantity",label:"Quantity",initialValue:n[3]},{id:"managedBy",label:"Managed By",initialValue:(Q.getPlatform()==="ios","AgSkan Website")}],$$slots:{buttons:[qe]},$$scope:{ctx:n}}}),{c(){O(e.$$.fragment)},l(t){B(e.$$.fragment,t)},m(t,o){A(e,t,o),s=!0},p(t,o){const i={};o&28&&(i.fields=[{id:"planName",label:"Current Plan",initialValue:t[4]},{id:"planStatus",label:"Status",initialValue:t[2]},{id:"quantity",label:"Quantity",initialValue:t[3]},{id:"managedBy",label:"Managed By",initialValue:(Q.getPlatform()==="ios","AgSkan Website")}]),o&65536&&(i.$$scope={dirty:o,ctx:t}),e.$set(i)},i(t){s||(E(e.$$.fragment,t),s=!0)},o(t){k(e.$$.fragment,t),s=!1},d(t){D(e,t)}}}function qe(n){let e;return{c(){e=$("div"),this.h()},l(s){e=w(s,"DIV",{slot:!0}),q(e).forEach(b),this.h()},h(){v(e,"slot","buttons")},m(s,t){_(s,e,t)},p:C,d(s){s&&b(e)}}}function Me(n){let e,s,t="Settings",o,i,a,p,l;const u=[Oe,Be],c=[];function g(f,d){return f[0]?0:1}return i=g(n),a=c[i]=u[i](n),{c(){e=V(),s=$("h1"),s.textContent=t,o=V(),a.c(),p=W(),this.h()},l(f){pe("svelte-hosjka",document.head).forEach(b),e=I(f),s=w(f,"H1",{class:!0,"data-svelte-h":!0}),M(s)!=="svelte-mlvd3d"&&(s.textContent=t),o=I(f),a.l(f),p=W(),this.h()},h(){document.title="Settings",v(s,"class","mb-6 text-2xl font-bold")},m(f,d){_(f,e,d),_(f,s,d),_(f,o,d),c[i].m(f,d),_(f,p,d),l=!0},p(f,[d]){let m=i;i=g(f),i===m?c[i].p(f,d):(be(),k(c[m],1,1,()=>{c[m]=null}),ge(),a=c[i],a?a.p(f,d):(a=c[i]=u[i](f),a.c()),E(a,1),a.m(p.parentNode,p))},i(f){l||(E(a),l=!0)},o(f){k(a),l=!1},d(f){f&&(b(e),b(s),b(o),b(p)),c[i].d(f)}}}function Fe(n,e,s){let t,o,i,a,p;K(n,ve,S=>s(7,a=S)),K(n,ae,S=>s(8,p=S)),me("adminSection").set("settings");let u=!0,c=null;const g=ye,f=Q.isNativePlatform();let d="FREE",m="Active",y="1",U=!1;async function T(){var S;try{const{data:N,error:P}=await we.from("user_subscriptions").select("*").eq("user_id",a.user.id).single();N&&!P&&(s(1,c=N),s(11,d=N.subscription||"FREE"),s(12,U=d!=="FREE"),s(2,m="Active"),s(3,y=((S=N.current_seats)==null?void 0:S.toString())||"1"))}catch(N){console.error("Error fetching subscription:",N)}}return fe(async()=>{if(!a){$e("/login");return}(!p||!p.id)&&await ae.loadProfile(a.user.id),await T(),s(0,u=!1)}),n.$$.update=()=>{n.$$.dirty&4096&&s(6,t=U?"Manage Subscription":"Upgrade Plan"),n.$$.dirty&2048&&s(4,i=d==="FREE"?"Free Plan":d.charAt(0)+d.slice(1).toLowerCase()+" Plan")},s(5,o="/account/billing"),[u,c,m,y,i,o,t,a,p,g,f,d,U]}class Ze extends G{constructor(e){super(),X(this,e,Fe,Me,J,{})}}export{Ze as component};

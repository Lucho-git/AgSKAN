import{i as le,s as Z,a as h}from"../chunks/sessionStore.a0feee67.js";import"../chunks/index.3feb4388.js";import{P as ce,s as ue,w as B,j as F,d as q,l as X,z as Y,m as de,u as _e,o as me,p as fe,e as P,a as J,t as pe,c as C,b as N,g as V,f as W,h as ge,i as w,k,B as he,q as be,n as T}from"../chunks/scheduler.0ff5556b.js";import{S as ye,i as ve,t as H,b as G,g as ke,e as xe}from"../chunks/index.e3d1f712.js";import{g as S}from"../chunks/navigation.f06e96a7.js";import{b as we}from"../chunks/environment.60829b93.js";import{p as Se}from"../chunks/stores.7b09ef55.js";import"../chunks/Toaster.svelte_svelte_type_style_lang.7b1bf8eb.js";import{p as Pe}from"../chunks/profileStore.99d1945a.js";import{s as Ce}from"../chunks/subscriptionStore.03b183c4.js";import{c as qe}from"../chunks/connectedMapStore.d86a965d.js";import{m as De}from"../chunks/mapActivityStore.e6a2ac64.js";import{o as Ae,s as je}from"../chunks/operationStore.2d5735a4.js";const Le=async()=>{try{return{sessionStatus:"initializing",sessionPromise:le().then(()=>{var s,e;const t=ce(Z);return{isAuthenticated:!!((s=t==null?void 0:t.user)!=null&&s.id),userId:(e=t==null?void 0:t.user)==null?void 0:e.id}})}}catch(l){return console.error("Error in layout load:",l),{sessionStatus:"error",error:l.message}}},Oe=!1,Ze=Object.freeze(Object.defineProperty({__proto__:null,load:Le,ssr:Oe},Symbol.toStringTag,{value:"Module"}));function Ee(l){let t,s,e,o;const u=[ze,Te,Ie],d=[];function c(n,f){return n[0]?0:n[1]?1:2}return t=c(l),s=d[t]=u[t](l),{c(){s.c(),e=B()},l(n){s.l(n),e=B()},m(n,f){d[t].m(n,f),F(n,e,f),o=!0},p(n,f){let _=t;t=c(n),t===_?d[t].p(n,f):(ke(),G(d[_],1,1,()=>{d[_]=null}),xe(),s=d[t],s?s.p(n,f):(s=d[t]=u[t](n),s.c()),H(s,1),s.m(e.parentNode,e))},i(n){o||(H(s),o=!0)},o(n){G(s),o=!1},d(n){n&&q(e),d[t].d(n)}}}function Ie(l){let t;const s=l[4].default,e=de(s,l,l[3],null);return{c(){e&&e.c()},l(o){e&&e.l(o)},m(o,u){e&&e.m(o,u),t=!0},p(o,u){e&&e.p&&(!t||u&8)&&_e(e,s,o,o[3],t?fe(s,o[3],u,null):me(o[3]),null)},i(o){t||(H(e,o),t=!0)},o(o){G(e,o),t=!1},d(o){e&&e.d(o)}}}function Te(l){let t,s,e,o="Error Loading Account",u,d,c=(l[1].message||"Unknown error occurred")+"",n,f,_,g,z="Try Again",E,b,M="Back to Login",A,R;return{c(){t=P("div"),s=P("div"),e=P("h2"),e.textContent=o,u=J(),d=P("p"),n=pe(c),f=J(),_=P("div"),g=P("button"),g.textContent=z,E=J(),b=P("a"),b.textContent=M,this.h()},l(x){t=C(x,"DIV",{class:!0});var r=N(t);s=C(r,"DIV",{class:!0});var a=N(s);e=C(a,"H2",{class:!0,"data-svelte-h":!0}),V(e)!=="svelte-135zzb6"&&(e.textContent=o),u=W(a),d=C(a,"P",{class:!0});var p=N(d);n=ge(p,c),p.forEach(q),f=W(a),_=C(a,"DIV",{class:!0});var m=N(_);g=C(m,"BUTTON",{class:!0,"data-svelte-h":!0}),V(g)!=="svelte-9gqfuk"&&(g.textContent=z),E=W(m),b=C(m,"A",{href:!0,class:!0,"data-svelte-h":!0}),V(b)!=="svelte-abcnec"&&(b.textContent=M),m.forEach(q),a.forEach(q),r.forEach(q),this.h()},h(){w(e,"class","text-2xl font-bold text-red-700"),w(d,"class","mt-2 text-red-600"),w(g,"class","rounded bg-primary px-4 py-2 text-white"),w(b,"href","/login"),w(b,"class","rounded border border-gray-300 bg-white px-4 py-2 text-gray-700"),w(_,"class","mt-6 flex justify-center space-x-4"),w(s,"class","max-w-md rounded-lg bg-red-50 p-6 text-center shadow-lg"),w(t,"class","flex h-screen w-full items-center justify-center")},m(x,r){F(x,t,r),k(t,s),k(s,e),k(s,u),k(s,d),k(d,n),k(s,f),k(s,_),k(_,g),k(_,E),k(_,b),A||(R=he(g,"click",l[5]),A=!0)},p(x,r){r&2&&c!==(c=(x[1].message||"Unknown error occurred")+"")&&be(n,c)},i:T,o:T,d(x){x&&q(t),A=!1,R()}}}function ze(l){let t,s='<div class="flex flex-col items-center"><div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div> <p class="mt-4 text-xl font-medium">Loading your account...</p></div>';return{c(){t=P("div"),t.innerHTML=s,this.h()},l(e){t=C(e,"DIV",{class:!0,"data-svelte-h":!0}),V(t)!=="svelte-1g19t2"&&(t.innerHTML=s),this.h()},h(){w(t,"class","flex h-screen w-full items-center justify-center")},m(e,o){F(e,t,o)},p:T,i:T,o:T,d(e){e&&q(t)}}}function Me(l){let t,s,e=Ee(l);return{c(){e&&e.c(),t=B()},l(o){e&&e.l(o),t=B()},m(o,u){e&&e.m(o,u),F(o,t,u),s=!0},p(o,[u]){e.p(o,u)},i(o){s||(H(e),s=!0)},o(o){G(e),s=!1},d(o){o&&q(t),e&&e.d(o)}}}function Re(l,t,s){let e,o;X(l,Z,r=>s(9,e=r)),X(l,Se,r=>s(10,o=r));let{$$slots:u={},$$scope:d}=t,{data:c}=t,n=c.sessionStatus==="loading"||c.sessionStatus==="initializing",f=c.error||null,_=!1,g=null,z=!1;console.log("Account layout initializing"),console.log("Current session status:",c.sessionStatus),console.log("Current session state:",e);async function E(){var a,p,m;if(!((a=e==null?void 0:e.user)!=null&&a.id))return null;const r=e.user.id;console.log("Loading user data for:",r);try{const[D,j]=await Promise.all([h.from("profiles").select("*").eq("id",r).single(),h.from("user_subscriptions").select("*").eq("user_id",r).single()]),i=D.data,y=j.data;if(console.log("Profile loaded:",i==null?void 0:i.id),i&&Pe.set({id:i.id,full_name:i.full_name,email:i.email,company_name:i.company_name,website:i.website,user_type:i.role,master_map_id:i.master_map_id,recent_maps:i.recent_maps,selected_operation_id:i.selected_operation_id}),y&&Ce.set({subscription:y.subscription,marker_limit:y.marker_limit,trail_limit:y.trail_limit,lingering_seats:y.lingering_seats,current_seats:y.current_seats,next_billing_date:y.next_billing_date}),!(i!=null&&i.master_map_id))return{profile:i,subscription:y,connected_map:null};const[$,ee,te]=await Promise.all([h.from("master_maps").select("*").eq("id",i.master_map_id).single(),Promise.all([h.from("map_markers").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),h.from("trail_data").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),h.from("profiles").select("id, full_name").eq("master_map_id",i.master_map_id)]),h.from("operations").select("*").eq("master_map_id",i.master_map_id)]),v=$.data,[se,re,K]=ee,L=te.data;if(console.log("Map data loaded:",v==null?void 0:v.id),!v)return{profile:i,subscription:y,connected_map:null};const[oe,ae,ne]=await Promise.all([h.from("profiles").select("full_name").eq("id",v.master_user_id).single(),h.from("user_subscriptions").select("*").eq("user_id",v.master_user_id).single(),h.from("vehicle_state").select("*").eq("master_map_id",i.master_map_id).in("vehicle_id",((p=K.data)==null?void 0:p.map(U=>U.id))||[])]),O={id:v.id,map_name:v.map_name,master_user_id:v.master_user_id,owner:((m=oe.data)==null?void 0:m.full_name)||"Unknown",is_owner:r===v.master_user_id},I={marker_count:se.count||0,trail_count:re.count||0,connected_profiles:K.data||[],vehicle_states:ne.data||[]},Q=ae.data;if(qe.set({id:O.id,map_name:O.map_name,master_user_id:O.master_user_id,owner:O.owner,is_owner:O.is_owner,masterSubscription:Q||null,is_connected:!0}),De.set({marker_count:I.marker_count,trail_count:I.trail_count,connected_profiles:I.connected_profiles,vehicle_states:I.vehicle_states}),L!=null&&L.length){Ae.set(L);const U=L.find(ie=>ie.id===i.selected_operation_id);U&&je.set(U)}return{profile:i,subscription:y,connected_map:O,map_activity:I,master_subscription:Q,operations:L}}catch(D){return console.error("Error loading user data:",D),s(1,f=D),null}}async function b(r,a,p){if(!r||!we)return;const m={select_role:"/account/select_role",join_map:"/account/join_map",onboard_manager:"/account/onboard_manager",payment_plans:"/account/payment_plans",user_survey:"/account/user_survey",select_plan:"/account/select_plan"};if(!Object.values(m).some(j=>o.url.pathname===j||o.url.pathname.startsWith(j))){if(!r.role){S(m.select_role);return}if(!r.onboarded){if(r.role==="operator"){if(!a){S(m.join_map);return}}else if(r.role==="manager"){if(!p){S(m.payment_plans);return}S(m.onboard_manager);return}}}}function M(r,a){var p;console.log("Auth State Change:",{event:r,hasSession:!!a,userId:(p=a==null?void 0:a.user)==null?void 0:p.id}),r==="SIGNED_OUT"&&!_&&(_=!0,S("/login"))}async function A(){var r;try{if(!((r=e==null?void 0:e.user)!=null&&r.id)){console.log("No valid session, redirecting to login"),_=!0,S("/login");return}const a=await E();z=!0,console.log("Loaded User Data:",a),a&&await b(a.profile,a.connected_map,a.subscription),console.log("Data loading complete")}catch(a){console.error("Data loading error:",a),s(1,f=a)}finally{s(0,n=!1)}}async function R(){if(c.sessionPromise)try{if(!(await c.sessionPromise).isAuthenticated){console.log("Session not authenticated, redirecting to login"),_=!0,S("/login");return}await A()}catch(r){console.error("Error processing session:",r),s(1,f=r),s(0,n=!1)}else c.sessionStatus==="error"&&s(0,n=!1)}Y(()=>{var a;console.log("Account layout mounted"),c.sessionPromise?R():(a=e==null?void 0:e.user)!=null&&a.id?A():n||(_=!0,S("/login"));const{data:r}=h.auth.onAuthStateChange(M);return g=r.subscription.unsubscribe,()=>{console.log("Account layout unmounting"),g&&g()}}),Y(()=>{var r;if((r=e==null?void 0:e.user)!=null&&r.id){const p=document.cookie.split(";").reduce((m,D)=>{const[j,i]=D.trim().split("=");return m[j]=i,m},{}).pending_map_id;p&&(console.log("Found pending map cookie:",p),document.cookie="pending_map_id=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT",h.from("profiles").update({master_map_id:p}).eq("id",e.user.id).then(({error:m})=>{m||(window.location.href="/account")}))}});const x=()=>window.location.reload();return l.$$set=r=>{"data"in r&&s(2,c=r.data),"$$scope"in r&&s(3,d=r.$$scope)},[n,f,c,d,u,x]}class $e extends ye{constructor(t){super(),ve(this,t,Re,Me,ue,{data:2})}}export{$e as component,Ze as universal};

import{s as ue,n as ne,d as c,i as ee,r as de,f as T,z as ie,k as I,v as fe,q as N,a as e,b as H,c as f,e as v,g as ae,h as p,j as h,t as _}from"../chunks/DjMlahvE.js";import{S as pe,i as he}from"../chunks/KhAD1Hhl.js";import{g as _e}from"../chunks/CsvQbYGG.js";import{a as $,s as ce}from"../chunks/DSS83BMa.js";function ge(g){let i,r,d,y="Authentication Error",t,s,o,a,u,E="Return to login",n,l,w,P,x=(g[2].hash||"none")+"",O,B,U,V,M=(g[2].query||"none")+"",L,J,j,F,G=(g[2].sessionResult||"pending")+"",Q,K,Y,z,W=g[2].profileCreated?"Yes":"No",D,X,m,S,q=(g[2].redirectTo||"default")+"",C;return{c(){i=h("div"),r=h("div"),d=h("h2"),d.textContent=y,t=I(),s=h("p"),o=_(g[1]),a=I(),u=h("a"),u.textContent=E,n=I(),l=h("div"),w=h("p"),P=_("Hash: "),O=_(x),B=I(),U=h("p"),V=_("Query: "),L=_(M),J=I(),j=h("p"),F=_("Session Result: "),Q=_(G),K=I(),Y=h("p"),z=_("Profile Created/Updated: "),D=_(W),X=I(),m=h("p"),S=_("Redirect To: "),C=_(q),this.h()},l(b){i=f(b,"DIV",{class:!0});var R=v(i);r=f(R,"DIV",{class:!0});var A=v(r);d=f(A,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-bznbjw"&&(d.textContent=y),t=T(A),s=f(A,"P",{class:!0});var Z=v(s);o=p(Z,g[1]),Z.forEach(c),a=T(A),u=f(A,"A",{href:!0,class:!0,"data-svelte-h":!0}),ae(u)!=="svelte-1m5fy2z"&&(u.textContent=E),n=T(A),l=f(A,"DIV",{class:!0});var k=v(l);w=f(k,"P",{});var te=v(w);P=p(te,"Hash: "),O=p(te,x),te.forEach(c),B=T(k),U=f(k,"P",{});var re=v(U);V=p(re,"Query: "),L=p(re,M),re.forEach(c),J=T(k),j=f(k,"P",{});var oe=v(j);F=p(oe,"Session Result: "),Q=p(oe,G),oe.forEach(c),K=T(k),Y=f(k,"P",{});var se=v(Y);z=p(se,"Profile Created/Updated: "),D=p(se,W),se.forEach(c),X=T(k),m=f(k,"P",{});var le=v(m);S=p(le,"Redirect To: "),C=p(le,q),le.forEach(c),k.forEach(c),A.forEach(c),R.forEach(c),this.h()},h(){H(d,"class","mb-4 text-xl font-semibold"),H(s,"class","text-red-500"),H(u,"href","/login"),H(u,"class","mt-4 inline-block rounded bg-blue-500 px-4 py-2 text-white"),H(l,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),H(r,"class","text-center"),H(i,"class","flex h-screen items-center justify-center")},m(b,R){ee(b,i,R),e(i,r),e(r,d),e(r,t),e(r,s),e(s,o),e(r,a),e(r,u),e(r,n),e(r,l),e(l,w),e(w,P),e(w,O),e(l,B),e(l,U),e(U,V),e(U,L),e(l,J),e(l,j),e(j,F),e(j,Q),e(l,K),e(l,Y),e(Y,z),e(Y,D),e(l,X),e(l,m),e(m,S),e(m,C)},p(b,R){R&2&&N(o,b[1]),R&4&&x!==(x=(b[2].hash||"none")+"")&&N(O,x),R&4&&M!==(M=(b[2].query||"none")+"")&&N(L,M),R&4&&G!==(G=(b[2].sessionResult||"pending")+"")&&N(Q,G),R&4&&W!==(W=b[2].profileCreated?"Yes":"No")&&N(D,W),R&4&&q!==(q=(b[2].redirectTo||"default")+"")&&N(C,q)},d(b){b&&c(i)}}}function me(g){let i,r,d,y="Completing authentication...",t,s,o,a,u,E,n=(g[2].hash||"none")+"",l,w,P,x,O=(g[2].query||"none")+"",B,U,V,M,L=(g[2].sessionResult||"pending")+"",J,j,F,G,Q=g[2].profileCreated?"Yes":"No",K,Y,z,W,D=(g[2].redirectTo||"default")+"",X;return{c(){i=h("div"),r=h("div"),d=h("h2"),d.textContent=y,t=I(),s=h("div"),o=I(),a=h("div"),u=h("p"),E=_("Hash: "),l=_(n),w=I(),P=h("p"),x=_("Query: "),B=_(O),U=I(),V=h("p"),M=_("Session Result: "),J=_(L),j=I(),F=h("p"),G=_("Profile Created/Updated: "),K=_(Q),Y=I(),z=h("p"),W=_("Redirect To: "),X=_(D),this.h()},l(m){i=f(m,"DIV",{class:!0});var S=v(i);r=f(S,"DIV",{class:!0});var q=v(r);d=f(q,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-lpwua0"&&(d.textContent=y),t=T(q),s=f(q,"DIV",{class:!0}),v(s).forEach(c),o=T(q),a=f(q,"DIV",{class:!0});var C=v(a);u=f(C,"P",{});var b=v(u);E=p(b,"Hash: "),l=p(b,n),b.forEach(c),w=T(C),P=f(C,"P",{});var R=v(P);x=p(R,"Query: "),B=p(R,O),R.forEach(c),U=T(C),V=f(C,"P",{});var A=v(V);M=p(A,"Session Result: "),J=p(A,L),A.forEach(c),j=T(C),F=f(C,"P",{});var Z=v(F);G=p(Z,"Profile Created/Updated: "),K=p(Z,Q),Z.forEach(c),Y=T(C),z=f(C,"P",{});var k=v(z);W=p(k,"Redirect To: "),X=p(k,D),k.forEach(c),C.forEach(c),q.forEach(c),S.forEach(c),this.h()},h(){H(d,"class","mb-4 text-xl font-semibold"),H(s,"class","skeleton mb-4 h-12 w-12 rounded-full"),H(a,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),H(r,"class","text-center"),H(i,"class","flex h-screen items-center justify-center")},m(m,S){ee(m,i,S),e(i,r),e(r,d),e(r,t),e(r,s),e(r,o),e(r,a),e(a,u),e(u,E),e(u,l),e(a,w),e(a,P),e(P,x),e(P,B),e(a,U),e(a,V),e(V,M),e(V,J),e(a,j),e(a,F),e(F,G),e(F,K),e(a,Y),e(a,z),e(z,W),e(z,X)},p(m,S){S&4&&n!==(n=(m[2].hash||"none")+"")&&N(l,n),S&4&&O!==(O=(m[2].query||"none")+"")&&N(B,O),S&4&&L!==(L=(m[2].sessionResult||"pending")+"")&&N(J,L),S&4&&Q!==(Q=m[2].profileCreated?"Yes":"No")&&N(K,Q),S&4&&D!==(D=(m[2].redirectTo||"default")+"")&&N(X,D)},d(m){m&&c(i)}}}function ve(g){let i,r;function d(s,o){if(s[0])return me;if(s[1])return ge}let y=d(g),t=y&&y(g);return{c(){i=I(),t&&t.c(),r=ie(),this.h()},l(s){de("svelte-1ey0ckx",document.head).forEach(c),i=T(s),t&&t.l(s),r=ie(),this.h()},h(){document.title="Authentication"},m(s,o){ee(s,i,o),t&&t.m(s,o),ee(s,r,o)},p(s,[o]){y===(y=d(s))&&t?t.p(s,o):(t&&t.d(1),t=y&&y(s),t&&(t.c(),t.m(r.parentNode,r)))},i:ne,o:ne,d(s){s&&(c(i),c(r)),t&&t.d(s)}}}function Ee(g,i,r){let d=!0,y=null,t={hash:"",query:"",sessionResult:null,profileCreated:!1,redirectTo:""};async function s(o){var a,u,E;try{console.log("Creating or updating profile for user:",o.user.id);const n={id:o.user.id,email:o.user.email,full_name:((a=o.user.user_metadata)==null?void 0:a.full_name)||null,avatar_url:((u=o.user.user_metadata)==null?void 0:u.avatar_url)||null,updated_at:new Date().toISOString(),onboarded:!1,last_sign_in:new Date().toISOString(),provider:((E=o.user.app_metadata)==null?void 0:E.provider)||"email"};console.log("User data prepared:",n);const{data:l,error:w}=await $.from("profiles").select("id, created_at, email").eq("id",o.user.id).single();if(w&&w.code!=="PGRST116")return console.error("Error checking existing profile:",w),!1;if(l){console.log("Existing profile found, updating:",l);const{error:P}=await $.from("profiles").update({last_sign_in:n.last_sign_in,updated_at:n.updated_at,...l.email?{}:{email:n.email},...l.full_name?{}:{full_name:n.full_name},...l.avatar_url?{}:{avatar_url:n.avatar_url}}).eq("id",o.user.id);return P?(console.error("Error updating profile:",P),!1):(console.log("Profile updated successfully"),!0)}else{console.log("No existing profile found, creating new profile");const{error:P}=await $.from("profiles").insert({...n,created_at:new Date().toISOString()});if(P&&P.code!=="23505")return console.error("Error creating profile:",P),!1;{console.log("Profile created successfully for user:",o.user.id);const{error:x}=await $.from("user_subscriptions").insert({user_id:o.user.id,subscription:"FREE",marker_limit:100,trail_limit:1e5,current_seats:1,updated_at:new Date().toISOString(),created_at:new Date().toISOString()});return x&&x.code!=="23505"?console.error("Error creating subscription:",x):console.log("Free subscription created for user:",o.user.id),!0}}}catch(n){return console.error("Error in profile creation/update:",n),!1}}return fe(async()=>{console.log("Auth callback mounting - PROFILE CREATION WILL HAPPEN HERE");try{r(2,t.hash=window.location.hash,t),r(2,t.query=window.location.search,t);const o=new URLSearchParams(window.location.hash.substring(1)),a=new URLSearchParams(window.location.search);r(2,t.redirectTo=a.get("next")||"/account",t),console.log("Auth callback parameters:",{hash:o.toString(),query:a.toString(),redirectTo:t.redirectTo});let u=null;if(window.location.hash){console.log("Processing hash fragment");const E=o.get("access_token"),n=o.get("refresh_token");if(E&&n){console.log("Setting session from tokens");const{data:l,error:w}=await $.auth.setSession({access_token:E,refresh_token:n});if(w)throw w;u=l.session,l.session&&(console.log("Manually updating session store"),ce.set(l.session),r(2,t.profileCreated=await s(l.session),t),console.log("Profile creation result:",t.profileCreated))}}else if(a.get("type")==="recovery"||a.get("type")==="signup"){console.log("Processing code exchange");const{data:E,error:n}=await $.auth.exchangeCodeForSession(a.get("code"));if(n)throw n;u=E.session,E.session&&(console.log("Manually updating session store from code exchange"),ce.set(E.session),r(2,t.profileCreated=await s(E.session),t),console.log("Profile creation result:",t.profileCreated))}r(2,t.sessionResult=u?"success":"failure",t),console.log("Auth process complete, redirecting to:",t.redirectTo),setTimeout(()=>{_e(t.redirectTo)},1e3)}catch(o){console.error("Error during auth callback:",o),r(1,y=o.message),r(2,t.sessionResult="error: "+o.message,t),r(0,d=!1)}}),[d,y,t]}class Ce extends pe{constructor(i){super(),he(this,i,Ee,ve,ue,{})}}export{Ce as component};

import{s as j,n as C,d as h,b as w,i as _,a as B,A as z,c as S,e as q,f as P,j as $,k as E,l as H,z as ae,g as O,x as R,w as ce,y as ue}from"../chunks/Bqk-ehBx.js";import{S as J,i as Q,t as I,a as k,e as fe,d as T,m as D,c as V,b as A,g as de}from"../chunks/BSIXs_Xe.js";import{S as L}from"../chunks/BhmhPIG2.js";import{d as pe,P as ge,e as me}from"../chunks/BB96qp-T.js";import{s as be,a as he}from"../chunks/DsDOFx4q.js";import{p as ie}from"../chunks/BRXscziQ.js";import{g as _e}from"../chunks/YnN_FSkG.js";import{p as ye}from"../chunks/0WSeQaFH.js";import{s as K}from"../chunks/BZNkLwfI.js";import{t as W}from"../chunks/7sStqI9Q.js";function ne(){const o=navigator.userAgent,e=window.screen.width,t=window.screen.height;return/Android/i.test(o)?e<600?"Android Phone":"Android Tablet":/iPad|iPhone|iPod/.test(o)&&!window.MSStream?/iPad/.test(o)||Math.max(e,t)>1e3?"iOS Tablet":"iPhone":/Windows|Macintosh|Linux/.test(o)?"Desktop":"Unknown"}async function le(){return new Promise((o,e)=>{console.log("Starting getOrCreateDeviceId...");const t="SKANStarterDB",s="deviceInfo",r=indexedDB.open(t,1);r.onerror=n=>{console.error("IndexedDB error:",n),e("IndexedDB error")},r.onsuccess=n=>{console.log("IndexedDB opened successfully");const u=n.target.result.transaction([s],"readwrite").objectStore(s),l=u.get("deviceId");l.onsuccess=()=>{let f;l.result?(console.log("Existing deviceId found:",l.result),typeof l.result=="object"&&l.result.id&&l.result.type?f=l.result:(f={id:typeof l.result=="object"?l.result.id:l.result,type:ne()},u.put(f,"deviceId"))):(console.log("No existing deviceId, creating new one"),f={id:crypto.randomUUID(),type:ne()},u.put(f,"deviceId")),console.log("DeviceInfo:",f),o(f)},l.onerror=f=>{console.error("Error getting deviceId:",f),e("Error getting deviceId")}},r.onupgradeneeded=n=>{console.log("Upgrading or creating IndexedDB"),n.target.result.createObjectStore(s)}})}async function oe(o){if(console.log("Starting subscribeToPushNotifications for user:",o),"serviceWorker"in navigator&&"PushManager"in window)try{const e=await le();console.log("Device info:",e);const t=await navigator.serviceWorker.ready;console.log("Service Worker is ready");const s=new Uint8Array(JSON.parse(pe));console.log("Application Server Key:",s);const r=await t.pushManager.getSubscription();let n;if(r){console.log("Existing subscription found:",r);const u=new Uint8Array(r.options.applicationServerKey);we(u,s)?(console.log("Existing subscription is valid, reusing"),n=r):(console.log("Existing subscription uses different key, unsubscribing..."),await r.unsubscribe(),console.log("Unsubscribed from existing subscription"),n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s}),console.log("New subscription created:",n))}else console.log("No existing subscription found"),n=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s}),console.log("New subscription created:",n);console.log("Saving subscription to database...");const{data:a,error:d}=await K.from("push_subscriptions").upsert({user_id:o,device_id:e.id,device_type:e.type,subscription:JSON.stringify(n)},{onConflict:"user_id, device_id"});if(d)throw console.error("Error saving subscription to database:",d),new Error(`Failed to save subscription: ${d.message}`);return console.log("Subscription saved successfully:",a),{success:!0}}catch(e){return console.error("Error subscribing to push notifications:",e),{success:!1,error:e.message}}else return console.log("Push notifications not supported"),{success:!1,error:"Push notifications not supported"}}function we(o,e){if(o.byteLength!==e.byteLength)return!1;const t=new Int8Array(o),s=new Int8Array(e);for(let r=0;r!==o.byteLength;r++)if(t[r]!==s[r])return!1;return!0}async function ve(o,e,t){console.log("Sending push notification...",o,e,t);try{const s=await fetch("https://hmxxqacnzxqpcheoeidn.supabase.co/functions/v1/send-notification",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${ge}`},body:JSON.stringify({subscription:o,title:e,body:t})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to send push notification")}const r=await s.json();return console.log("Push notification sent successfully:",r),{success:!0,...r}}catch(s){return console.error("Error sending push notification:",s),{success:!1,error:s.message}}}function re(o){let e,t,s,r="Chat",n;function a(l,f){return l[1]!=="granted"?Se:Ne}let d=a(o),u=d(o);return{c(){e=$("div"),t=$("div"),s=$("h3"),s.textContent=r,n=E(),u.c(),this.h()},l(l){e=S(l,"DIV",{class:!0});var f=q(e);t=S(f,"DIV",{class:!0});var p=q(t);s=S(p,"H3",{class:!0,"data-svelte-h":!0}),O(s)!=="svelte-1ezxekg"&&(s.textContent=r),n=P(p),u.l(p),p.forEach(h),f.forEach(h),this.h()},h(){w(s,"class","card-title"),w(t,"class","card-body"),w(e,"class","card w-80 bg-base-100 shadow-xl mb-4")},m(l,f){_(l,e,f),B(e,t),B(t,s),B(t,n),u.m(t,null)},p(l,f){d===(d=a(l))&&u?u.p(l,f):(u.d(1),u=d(l),u&&(u.c(),u.m(t,null)))},d(l){l&&h(e),u.d()}}}function Ne(o){let e,t="Test Push Notification",s,r;return{c(){e=$("button"),e.textContent=t,this.h()},l(n){e=S(n,"BUTTON",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-9luf4i"&&(e.textContent=t),this.h()},h(){w(e,"class","btn btn-secondary")},m(n,a){_(n,e,a),s||(r=z(e,"click",o[4]),s=!0)},p:C,d(n){n&&h(e),s=!1,r()}}}function Se(o){let e,t="Enable Notifications",s,r;return{c(){e=$("button"),e.textContent=t,this.h()},l(n){e=S(n,"BUTTON",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-abvrqe"&&(e.textContent=t),this.h()},h(){w(e,"class","btn btn-primary")},m(n,a){_(n,e,a),s||(r=z(e,"click",o[3]),s=!0)},p:C,d(n){n&&h(e),s=!1,r()}}}function $e(o){let e,t,s,r,n,a,d,u=o[0]&&re(o);return{c(){e=$("div"),u&&u.c(),t=E(),s=$("button"),r=$("i"),this.h()},l(l){e=S(l,"DIV",{class:!0});var f=q(e);u&&u.l(f),t=P(f),s=S(f,"BUTTON",{class:!0});var p=q(s);r=S(p,"I",{class:!0}),q(r).forEach(h),p.forEach(h),f.forEach(h),this.h()},h(){w(r,"class",n=o[0]?"at-bell-minus":"at-bell-plus"),w(s,"class","btn btn-circle btn-lg btn-primary"),w(e,"class","fixed bottom-8 right-8 z-50 flex flex-col items-end")},m(l,f){_(l,e,f),u&&u.m(e,null),B(e,t),B(e,s),B(s,r),a||(d=z(s,"click",o[2]),a=!0)},p(l,[f]){l[0]?u?u.p(l,f):(u=re(l),u.c(),u.m(e,t)):u&&(u.d(1),u=null),f&1&&n!==(n=l[0]?"at-bell-minus":"at-bell-plus")&&w(r,"class",n)},i:C,o:C,d(l){l&&h(e),u&&u.d(),a=!1,d()}}}function Pe(o,e,t){let s;H(o,ye,p=>t(6,s=p));let r=!1,n="default",a;ae(async()=>{t(1,n=Notification.permission);const p=s.data.session;p&&(a=p.user.id)});function d(){t(0,r=!r),r&&u()}async function u(){if(console.log("Checking and updating subscription..."),console.log("Notification permission:",Notification.permission),console.log("User ID:",a),Notification.permission==="granted"&&a){console.log("Getting/Creating device id...");const p=await le();console.log("Device Info:",p);const{data:c,error:g}=await K.from("push_subscriptions").select("subscription").eq("user_id",a).eq("device_id",p.id).single();if(!c||g){console.log("No existing subscription found. Creating new subscription...");const m=await oe(a);console.log("Subscription result:",m),m.success?(t(1,n="granted"),console.log("New subscription created successfully")):console.error("Failed to create new subscription:",m.error)}else console.log("Existing subscription found. No update needed.")}else console.log("Notification permission not granted or user ID not available")}async function l(){const p=new Promise(async(c,g)=>{try{console.log("Current notification permission:",Notification.permission),console.log("Current user ID:",a);const m=await Notification.requestPermission();if(console.log("Requested permission result:",m),t(1,n=m),m!=="granted")console.log("Notification permission not granted"),g(new Error("Notification permission not granted"));else if(!a)console.log("User ID not available"),g(new Error("User ID not available"));else{console.log("Attempting to subscribe to push notifications");const y=await oe(a);console.log("Subscription result:",y),y.success?c("Notifications enabled successfully!"):g(new Error(y.error||"Failed to enable notifications"))}}catch(m){console.error("Error in enableNotifications:",m),g(m)}});W.promise(p,{loading:"Enabling notifications...",success:c=>c,error:c=>`Error: ${c.message}`})}async function f(){const p=new Promise(async(c,g)=>{try{const{data:m,error:y}=await K.from("push_subscriptions").select("subscription, device_type").eq("user_id",a);if(y)throw y;if(m&&m.length>0){const v=(await Promise.all(m.map(async i=>{const b=JSON.parse(i.subscription);return{...await ve(b,"Test Notification","Hi !"),deviceType:i.device_type}}))).filter(i=>i.success),N=v.length,x=v.map(i=>i.deviceType).join(", ");N>0?c(`Test notifications sent successfully to ${N} device(s)!
Devices: ${x}`):g(new Error("Failed to send notifications to any devices"))}else g(new Error("No subscriptions found for this user"))}catch(m){g(m)}});W.promise(p,{loading:"Sending test notifications...",success:c=>c,error:c=>`Error: ${c.message}`})}return[r,n,d,l,f]}class Ee extends J{constructor(e){super(),Q(this,e,Pe,$e,j,{})}}function Ce(o){let e;return{c(){e=R()},l(t){e=R()},m(t,s){_(t,e,s)},p(t,[s]){},i:C,o:C,d(t){t&&h(e)}}}function Ie(o,e,t){let s=!1,{data:r}=e;const n=()=>{t(0,s=!0),W.success("Test Button Pressed",{description:"This is a developer testing feature",duration:3e3}),setTimeout(()=>{t(0,s=!1)},1e3)};return o.$$set=a=>{"data"in a&&t(2,r=a.data)},[s,n,r]}class ke extends J{constructor(e){super(),Q(this,e,Ie,Ce,j,{data:2})}}function Te(o){var y,U,v,N,x;let e,t,s,r,n,a,d,u,l,f,p,c,g,m;return e=new L({props:{title:"Profile",editable:!1,fields:[{id:"fullName",label:"Name",initialValue:((y=o[8])==null?void 0:y.full_name)??""},{id:"companyName",label:"Company Name",initialValue:((U=o[8])==null?void 0:U.company_name)??""},{id:"website",label:"Company Website",initialValue:((v=o[8])==null?void 0:v.website)??""}],$$slots:{buttons:[Ve]},$$scope:{ctx:o}}}),s=new L({props:{title:"Email",editable:!1,fields:[{id:"email",initialValue:((x=(N=o[7])==null?void 0:N.user)==null?void 0:x.email)||""}],editButtonTitle:"Change Email",editLink:"/account/settings/change_email"}}),n=new L({props:{title:"Password",editable:!1,fields:[{id:"password",initialValue:"••••••••••••••••"}],editButtonTitle:"Change Password",editLink:"/account/settings/change_password"}}),d=new L({props:{title:"Subscription",editable:!1,fields:[{id:"planName",label:"Current Plan",initialValue:o[4]},{id:"planStatus",label:"Status",initialValue:o[2]},{id:"quantity",label:"Quantity",initialValue:o[3]}],editButtonTitle:o[6],editLink:o[5]}}),l=new L({props:{title:"App Version",editable:!1,dangerous:!0,fields:[{id:"version",initialValue:o[9]}],editButtonTitle:"Delete Account",editLink:"/account/settings/delete_account"}}),p=new Ee({}),g=new ke({props:{data:{session:o[7],profile:o[8],subscriptionData:o[1]}}}),{c(){A(e.$$.fragment),t=E(),A(s.$$.fragment),r=E(),A(n.$$.fragment),a=E(),A(d.$$.fragment),u=E(),A(l.$$.fragment),f=E(),A(p.$$.fragment),c=E(),A(g.$$.fragment)},l(i){V(e.$$.fragment,i),t=P(i),V(s.$$.fragment,i),r=P(i),V(n.$$.fragment,i),a=P(i),V(d.$$.fragment,i),u=P(i),V(l.$$.fragment,i),f=P(i),V(p.$$.fragment,i),c=P(i),V(g.$$.fragment,i)},m(i,b){D(e,i,b),_(i,t,b),D(s,i,b),_(i,r,b),D(n,i,b),_(i,a,b),D(d,i,b),_(i,u,b),D(l,i,b),_(i,f,b),D(p,i,b),_(i,c,b),D(g,i,b),m=!0},p(i,b){var X,Z,ee,te,se;const M={};b&256&&(M.fields=[{id:"fullName",label:"Name",initialValue:((X=i[8])==null?void 0:X.full_name)??""},{id:"companyName",label:"Company Name",initialValue:((Z=i[8])==null?void 0:Z.company_name)??""},{id:"website",label:"Company Website",initialValue:((ee=i[8])==null?void 0:ee.website)??""}]),b&32768&&(M.$$scope={dirty:b,ctx:i}),e.$set(M);const Y={};b&128&&(Y.fields=[{id:"email",initialValue:((se=(te=i[7])==null?void 0:te.user)==null?void 0:se.email)||""}]),s.$set(Y);const F={};b&28&&(F.fields=[{id:"planName",label:"Current Plan",initialValue:i[4]},{id:"planStatus",label:"Status",initialValue:i[2]},{id:"quantity",label:"Quantity",initialValue:i[3]}]),b&64&&(F.editButtonTitle=i[6]),b&32&&(F.editLink=i[5]),d.$set(F);const G={};b&386&&(G.data={session:i[7],profile:i[8],subscriptionData:i[1]}),g.$set(G)},i(i){m||(k(e.$$.fragment,i),k(s.$$.fragment,i),k(n.$$.fragment,i),k(d.$$.fragment,i),k(l.$$.fragment,i),k(p.$$.fragment,i),k(g.$$.fragment,i),m=!0)},o(i){I(e.$$.fragment,i),I(s.$$.fragment,i),I(n.$$.fragment,i),I(d.$$.fragment,i),I(l.$$.fragment,i),I(p.$$.fragment,i),I(g.$$.fragment,i),m=!1},d(i){i&&(h(t),h(r),h(a),h(u),h(f),h(c)),T(e,i),T(s,i),T(n,i),T(d,i),T(l,i),T(p,i),T(g,i)}}}function De(o){let e,t='<div class="loading loading-spinner loading-lg"></div>';return{c(){e=$("div"),e.innerHTML=t,this.h()},l(s){e=S(s,"DIV",{class:!0,"data-svelte-h":!0}),O(e)!=="svelte-asr66p"&&(e.innerHTML=t),this.h()},h(){w(e,"class","flex h-64 items-center justify-center")},m(s,r){_(s,e,r)},p:C,i:C,o:C,d(s){s&&h(e)}}}function Ve(o){let e,t='<a href="/account/settings/edit_profile"><button class="btn btn-outline btn-sm min-w-[145px]">Edit Profile</button></a> <a href="/account/sign_out"><button class="btn btn-outline btn-error btn-sm min-w-[145px]">Sign Out</button></a>';return{c(){e=$("div"),e.innerHTML=t,this.h()},l(s){e=S(s,"DIV",{class:!0,slot:!0,"data-svelte-h":!0}),O(e)!=="svelte-g8yf64"&&(e.innerHTML=t),this.h()},h(){w(e,"class","flex flex-col gap-2"),w(e,"slot","buttons")},m(s,r){_(s,e,r)},p:C,d(s){s&&h(e)}}}function Ae(o){let e,t,s="Settings",r,n,a,d,u;const l=[De,Te],f=[];function p(c,g){return c[0]?0:1}return n=p(o),a=f[n]=l[n](o),{c(){e=E(),t=$("h1"),t.textContent=s,r=E(),a.c(),d=R(),this.h()},l(c){ce("svelte-hosjka",document.head).forEach(h),e=P(c),t=S(c,"H1",{class:!0,"data-svelte-h":!0}),O(t)!=="svelte-mlvd3d"&&(t.textContent=s),r=P(c),a.l(c),d=R(),this.h()},h(){document.title="Settings",w(t,"class","mb-6 text-2xl font-bold")},m(c,g){_(c,e,g),_(c,t,g),_(c,r,g),f[n].m(c,g),_(c,d,g),u=!0},p(c,[g]){let m=n;n=p(c),n===m?f[n].p(c,g):(de(),I(f[m],1,1,()=>{f[m]=null}),fe(),a=f[n],a?a.p(c,g):(a=f[n]=l[n](c),a.c()),k(a,1),a.m(d.parentNode,d))},i(c){u||(k(a),u=!0)},o(c){I(a),u=!1},d(c){c&&(h(e),h(t),h(r),h(d)),f[n].d(c)}}}function xe(o,e,t){let s,r,n,a,d;H(o,be,v=>t(7,a=v)),H(o,ie,v=>t(8,d=v)),ue("adminSection").set("settings");let l=!0,f=null;const p=me;let c="FREE",g="Active",m="1",y=!1;async function U(){var v;try{const{data:N,error:x}=await he.from("user_subscriptions").select("*").eq("user_id",a.user.id).single();N&&!x&&(t(1,f=N),t(10,c=N.subscription||"FREE"),t(11,y=c!=="FREE"),t(2,g="Active"),t(3,m=((v=N.current_seats)==null?void 0:v.toString())||"1"))}catch(N){console.error("Error fetching subscription:",N)}}return ae(async()=>{if(!a){_e("/login");return}(!d||!d.id)&&await ie.loadProfile(a.user.id),await U(),t(0,l=!1)}),o.$$.update=()=>{o.$$.dirty&2048&&t(6,s=y?"Manage Subscription":"Upgrade Plan"),o.$$.dirty&1024&&t(4,n=c==="FREE"?"Free Plan":c.charAt(0)+c.slice(1).toLowerCase()+" Plan")},t(5,r="/account/billing"),[l,f,g,m,n,r,s,a,d,p,c,y]}class We extends J{constructor(e){super(),Q(this,e,xe,Ae,j,{})}}export{We as component};

import{i as fe,s as oe,a as g,g as ge,c as J}from"../chunks/DsDOFx4q.js";import"../chunks/CR0wtSc3.js";import{P as he,s as be,d as M,i as Y,x as B,l as $,z as ye,n as z,b as w,c as A,g as H,j as D,q as ve,a as k,A as ke,e as V,f as K,h as we,k as Q,t as xe,m as Pe,u as Se,o as Ce,p as Ae}from"../chunks/Bqk-ehBx.js";import{S as De,i as Me,t as G,a as W,g as qe,e as Ie}from"../chunks/BSIXs_Xe.js";import{g as C}from"../chunks/DwAXOYQ9.js";import{p as je}from"../chunks/D5hcW57D.js";import{t as ee}from"../chunks/7sStqI9Q.js";import{p as Ee}from"../chunks/BRXscziQ.js";import{s as Le}from"../chunks/D9tfuetc.js";import{c as te}from"../chunks/gy0Skyka.js";import{m as se}from"../chunks/fLtZWlj4.js";import{o as ae,s as re}from"../chunks/BUeu0Hhy.js";import{m as Oe}from"../chunks/DWiAzEEH.js";const ze=async()=>{try{return{sessionStatus:"initializing",sessionPromise:fe().then(()=>{var s,e;const t=he(oe);return{isAuthenticated:!!((s=t==null?void 0:t.user)!=null&&s.id),userId:(e=t==null?void 0:t.user)==null?void 0:e.id}})}}catch(l){return console.error("Error in layout load:",l),{sessionStatus:"error",error:l.message}}},Re=!1,at=Object.freeze(Object.defineProperty({__proto__:null,load:ze,ssr:Re},Symbol.toStringTag,{value:"Module"}));function Te(l){let t,s,e,a;const u=[Fe,Ne,Ue],d=[];function c(n,p){return n[0]?0:n[1]?1:2}return t=c(l),s=d[t]=u[t](l),{c(){s.c(),e=B()},l(n){s.l(n),e=B()},m(n,p){d[t].m(n,p),Y(n,e,p),a=!0},p(n,p){let m=t;t=c(n),t===m?d[t].p(n,p):(qe(),G(d[m],1,1,()=>{d[m]=null}),Ie(),s=d[t],s?s.p(n,p):(s=d[t]=u[t](n),s.c()),W(s,1),s.m(e.parentNode,e))},i(n){a||(W(s),a=!0)},o(n){G(s),a=!1},d(n){n&&M(e),d[t].d(n)}}}function Ue(l){let t;const s=l[4].default,e=Pe(s,l,l[3],null);return{c(){e&&e.c()},l(a){e&&e.l(a)},m(a,u){e&&e.m(a,u),t=!0},p(a,u){e&&e.p&&(!t||u&8)&&Se(e,s,a,a[3],t?Ae(s,a[3],u,null):Ce(a[3]),null)},i(a){t||(W(e,a),t=!0)},o(a){G(e,a),t=!1},d(a){e&&e.d(a)}}}function Ne(l){let t,s,e,a="Error Loading Account",u,d,c=(l[1].message||"Unknown error occurred")+"",n,p,m,f,R="Try Again",q,h,T="Back to Login",L,U;return{c(){t=D("div"),s=D("div"),e=D("h2"),e.textContent=a,u=Q(),d=D("p"),n=xe(c),p=Q(),m=D("div"),f=D("button"),f.textContent=R,q=Q(),h=D("a"),h.textContent=T,this.h()},l(b){t=A(b,"DIV",{class:!0});var x=V(t);s=A(x,"DIV",{class:!0});var P=V(s);e=A(P,"H2",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-135zzb6"&&(e.textContent=a),u=K(P),d=A(P,"P",{class:!0});var r=V(d);n=we(r,c),r.forEach(M),p=K(P),m=A(P,"DIV",{class:!0});var o=V(m);f=A(o,"BUTTON",{class:!0,"data-svelte-h":!0}),H(f)!=="svelte-9gqfuk"&&(f.textContent=R),q=K(o),h=A(o,"A",{href:!0,class:!0,"data-svelte-h":!0}),H(h)!=="svelte-abcnec"&&(h.textContent=T),o.forEach(M),P.forEach(M),x.forEach(M),this.h()},h(){w(e,"class","text-2xl font-bold text-red-700"),w(d,"class","mt-2 text-red-600"),w(f,"class","rounded bg-primary px-4 py-2 text-white"),w(h,"href","/login"),w(h,"class","rounded border border-gray-300 bg-white px-4 py-2 text-gray-700"),w(m,"class","mt-6 flex justify-center space-x-4"),w(s,"class","max-w-md rounded-lg bg-red-50 p-6 text-center shadow-lg"),w(t,"class","flex h-screen w-full items-center justify-center")},m(b,x){Y(b,t,x),k(t,s),k(s,e),k(s,u),k(s,d),k(d,n),k(s,p),k(s,m),k(m,f),k(m,q),k(m,h),L||(U=ke(f,"click",l[5]),L=!0)},p(b,x){x&2&&c!==(c=(b[1].message||"Unknown error occurred")+"")&&ve(n,c)},i:z,o:z,d(b){b&&M(t),L=!1,U()}}}function Fe(l){let t,s='<div class="flex flex-col items-center"><div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div> <p class="mt-4 text-xl font-medium">Loading your account...</p></div>';return{c(){t=D("div"),t.innerHTML=s,this.h()},l(e){t=A(e,"DIV",{class:!0,"data-svelte-h":!0}),H(t)!=="svelte-1g19t2"&&(t.innerHTML=s),this.h()},h(){w(t,"class","flex h-screen w-full items-center justify-center")},m(e,a){Y(e,t,a)},p:z,i:z,o:z,d(e){e&&M(t)}}}function Ve(l){let t,s,e=Te(l);return{c(){e&&e.c(),t=B()},l(a){e&&e.l(a),t=B()},m(a,u){e&&e.m(a,u),Y(a,t,u),s=!0},p(a,[u]){e.p(a,u)},i(a){s||(W(e),s=!0)},o(a){G(e),s=!1},d(a){a&&M(t),e&&e.d(a)}}}function He(l,t,s){let e,a;$(l,oe,r=>s(10,e=r)),$(l,je,r=>s(11,a=r));let{$$slots:u={},$$scope:d}=t,{data:c}=t,n=c.sessionStatus==="loading"||c.sessionStatus==="initializing",p=c.error||null,m=!1,f=null,R=!1,q=!1;console.log("Account layout initializing"),console.log("Current session status:",c.sessionStatus),console.log("Current session state:",e);async function h(){var r;if(!((r=e==null?void 0:e.user)!=null&&r.id)||q)return!1;try{q=!0;const o=ge();if(!o)return!1;console.log(`Found pending map ID: ${o}`);const _=await Oe.connectToMap(o);return _.success?(console.log("Successfully connected to map:",_.data),te.set(_.data.connectedMap),se.set(_.data.mapActivity),ae.set(_.data.operations||[]),_.data.operation&&re.set(_.data.operation),J(),ee.success(`You've been connected to map: ${_.data.mapName}`),window.location.reload(),!0):(console.error("Failed to connect to map:",_.message),ee.error(`Failed to connect to map: ${_.message}`),J(),!1)}catch(o){return console.error("Error processing pending map connection:",o),J(),!1}}async function T(){var o,_,S;if(!((o=e==null?void 0:e.user)!=null&&o.id))return null;const r=e.user.id;if(console.log("Loading user data for:",r),!q&&await h())return{pendingMapProcessing:!0};try{const[I,N]=await Promise.all([g.from("profiles").select("*").eq("id",r).single(),g.from("user_subscriptions").select("*").eq("user_id",r).single()]),i=I.data,y=N.data;if(console.log("Profile loaded:",i==null?void 0:i.id),i&&Ee.set({id:i.id,full_name:i.full_name,email:i.email,company_name:i.company_name,website:i.website,user_type:i.role,master_map_id:i.master_map_id,recent_maps:i.recent_maps,selected_operation_id:i.selected_operation_id}),y&&Le.set({subscription:y.subscription,marker_limit:y.marker_limit,trail_limit:y.trail_limit,lingering_seats:y.lingering_seats,current_seats:y.current_seats,next_billing_date:y.next_billing_date}),!(i!=null&&i.master_map_id))return{profile:i,subscription:y,connected_map:null};const[ne,ie,le]=await Promise.all([g.from("master_maps").select("*").eq("id",i.master_map_id).single(),Promise.all([g.from("map_markers").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),g.from("trail_data").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),g.from("profiles").select("id, full_name").eq("master_map_id",i.master_map_id)]),g.from("operations").select("*").eq("master_map_id",i.master_map_id)]),v=ne.data,[ce,ue,X]=ie,j=le.data;if(console.log("Map data loaded:",v==null?void 0:v.id),!v)return{profile:i,subscription:y,connected_map:null};const[de,me,_e]=await Promise.all([g.from("profiles").select("full_name").eq("id",v.master_user_id).single(),g.from("user_subscriptions").select("*").eq("user_id",v.master_user_id).single(),g.from("vehicle_state").select("*").eq("master_map_id",i.master_map_id).in("vehicle_id",((_=X.data)==null?void 0:_.map(F=>F.id))||[])]),E={id:v.id,map_name:v.map_name,master_user_id:v.master_user_id,owner:((S=de.data)==null?void 0:S.full_name)||"Unknown",is_owner:r===v.master_user_id},O={marker_count:ce.count||0,trail_count:ue.count||0,connected_profiles:X.data||[],vehicle_states:_e.data||[]},Z=me.data;if(te.set({id:E.id,map_name:E.map_name,master_user_id:E.master_user_id,owner:E.owner,is_owner:E.is_owner,masterSubscription:Z||null,is_connected:!0}),se.set({marker_count:O.marker_count,trail_count:O.trail_count,connected_profiles:O.connected_profiles,vehicle_states:O.vehicle_states}),j!=null&&j.length){ae.set(j);const F=j.find(pe=>pe.id===i.selected_operation_id);F&&re.set(F)}return{profile:i,subscription:y,connected_map:E,map_activity:O,master_subscription:Z,operations:j}}catch(I){return console.error("Error loading user data:",I),s(1,p=I),null}}async function L(r,o,_){if(!r)return;const S={select_role:"/account/select_role",join_map:"/account/join_map",onboard_manager:"/account/onboard_manager",payment_plans:"/account/payment_plans",user_survey:"/account/user_survey",select_plan:"/account/select_plan"};if(!Object.values(S).some(N=>a.url.pathname===N||a.url.pathname.startsWith(N))){if(!r.role){C(S.select_role);return}if(!r.onboarded){if(r.role==="operator"){if(!o){C(S.join_map);return}}else if(r.role==="manager"){if(!_){C(S.payment_plans);return}C(S.onboard_manager);return}}}}function U(r,o){var _;console.log("Auth State Change:",{event:r,hasSession:!!o,userId:(_=o==null?void 0:o.user)==null?void 0:_.id}),r==="SIGNED_OUT"&&!m&&(m=!0,C("/login"))}async function b(){var r;try{if(!((r=e==null?void 0:e.user)!=null&&r.id)){console.log("No valid session, redirecting to login"),m=!0,C("/login");return}const o=await T();if(R=!0,console.log("Loaded User Data:",o),o&&o.pendingMapProcessing)return;o&&await L(o.profile,o.connected_map,o.subscription),console.log("Data loading complete")}catch(o){console.error("Data loading error:",o),s(1,p=o)}finally{s(0,n=!1)}}async function x(){if(c.sessionPromise)try{if(!(await c.sessionPromise).isAuthenticated){console.log("Session not authenticated, redirecting to login"),m=!0,C("/login");return}await b()}catch(r){console.error("Error processing session:",r),s(1,p=r),s(0,n=!1)}else c.sessionStatus==="error"&&s(0,n=!1)}ye(()=>{var o;console.log("Account layout mounted"),c.sessionPromise?x():(o=e==null?void 0:e.user)!=null&&o.id?b():n||(m=!0,C("/login"));const{data:r}=g.auth.onAuthStateChange(U);return f=r.subscription.unsubscribe,()=>{console.log("Account layout unmounting"),f&&f()}});const P=()=>window.location.reload();return l.$$set=r=>{"data"in r&&s(2,c=r.data),"$$scope"in r&&s(3,d=r.$$scope)},[n,p,c,d,u,P]}class rt extends De{constructor(t){super(),Me(this,t,He,Ve,be,{data:2})}}export{rt as component,at as universal};

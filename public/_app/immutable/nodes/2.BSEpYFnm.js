import{i as me,s as oe,a as g,g as _e,c as W}from"../chunks/sessionStore.B10XaNYZ.js";import"../chunks/index.D6ASlNOC.js";import{P as pe,s as fe,d as M,i as B,x as F,l as X,z as ge,n as j,b as v,c as P,g as N,j as C,q as he,a as y,A as be,e as U,f as Y,h as ye,k as J,t as ve,m as we,u as Se,o as ke,p as xe}from"../chunks/scheduler.BVGjjnGO.js";import{S as Pe,i as Ce,t as V,a as H,g as Me,e as Ae}from"../chunks/index.Vv2yv23T.js";import{g as x}from"../chunks/entry.Do23-0vY.js";import{p as De}from"../chunks/stores.CGFxa5OV.js";import{t as Z}from"../chunks/Toaster.svelte_svelte_type_style_lang.BcvbULy5.js";import{p as qe}from"../chunks/profileStore.DorDk9Q6.js";import{s as Ie}from"../chunks/subscriptionStore.DSonUdJX.js";import{c as $}from"../chunks/connectedMapStore.vcjAOVZs.js";import{m as ee}from"../chunks/mapActivityStore.BMkPVnUJ.js";import{o as te,s as se}from"../chunks/operationStore.DMok4-vU.js";import{m as je}from"../chunks/mapApi.pmjJZ6yb.js";const Ee=async()=>{try{return{sessionStatus:"initializing",sessionPromise:me().then(()=>{const t=pe(oe);return{isAuthenticated:!!t?.user?.id,userId:t?.user?.id}})}}catch(l){return console.error("Error in layout load:",l),{sessionStatus:"error",error:l.message}}},Le=!1,et=Object.freeze(Object.defineProperty({__proto__:null,load:Ee,ssr:Le},Symbol.toStringTag,{value:"Module"}));function Oe(l){let t,o,e,a;const u=[Te,Re,ze],d=[];function c(r,_){return r[0]?0:r[1]?1:2}return t=c(l),o=d[t]=u[t](l),{c(){o.c(),e=F()},l(r){o.l(r),e=F()},m(r,_){d[t].m(r,_),B(r,e,_),a=!0},p(r,_){let m=t;t=c(r),t===m?d[t].p(r,_):(Me(),V(d[m],1,1,()=>{d[m]=null}),Ae(),o=d[t],o?o.p(r,_):(o=d[t]=u[t](r),o.c()),H(o,1),o.m(e.parentNode,e))},i(r){a||(H(o),a=!0)},o(r){V(o),a=!1},d(r){r&&M(e),d[t].d(r)}}}function ze(l){let t;const o=l[4].default,e=we(o,l,l[3],null);return{c(){e&&e.c()},l(a){e&&e.l(a)},m(a,u){e&&e.m(a,u),t=!0},p(a,u){e&&e.p&&(!t||u&8)&&Se(e,o,a,a[3],t?xe(o,a[3],u,null):ke(a[3]),null)},i(a){t||(H(e,a),t=!0)},o(a){V(e,a),t=!1},d(a){e&&e.d(a)}}}function Re(l){let t,o,e,a="Error Loading Account",u,d,c=(l[1].message||"Unknown error occurred")+"",r,_,m,p,E="Try Again",A,h,L="Back to Login",q,O;return{c(){t=C("div"),o=C("div"),e=C("h2"),e.textContent=a,u=J(),d=C("p"),r=ve(c),_=J(),m=C("div"),p=C("button"),p.textContent=E,A=J(),h=C("a"),h.textContent=L,this.h()},l(b){t=P(b,"DIV",{class:!0});var w=U(t);o=P(w,"DIV",{class:!0});var S=U(o);e=P(S,"H2",{class:!0,"data-svelte-h":!0}),N(e)!=="svelte-135zzb6"&&(e.textContent=a),u=Y(S),d=P(S,"P",{class:!0});var s=U(d);r=ye(s,c),s.forEach(M),_=Y(S),m=P(S,"DIV",{class:!0});var i=U(m);p=P(i,"BUTTON",{class:!0,"data-svelte-h":!0}),N(p)!=="svelte-9gqfuk"&&(p.textContent=E),A=Y(i),h=P(i,"A",{href:!0,class:!0,"data-svelte-h":!0}),N(h)!=="svelte-abcnec"&&(h.textContent=L),i.forEach(M),S.forEach(M),w.forEach(M),this.h()},h(){v(e,"class","text-2xl font-bold text-red-700"),v(d,"class","mt-2 text-red-600"),v(p,"class","rounded bg-primary px-4 py-2 text-white"),v(h,"href","/login"),v(h,"class","rounded border border-gray-300 bg-white px-4 py-2 text-gray-700"),v(m,"class","mt-6 flex justify-center space-x-4"),v(o,"class","max-w-md rounded-lg bg-red-50 p-6 text-center shadow-lg"),v(t,"class","flex h-screen w-full items-center justify-center")},m(b,w){B(b,t,w),y(t,o),y(o,e),y(o,u),y(o,d),y(d,r),y(o,_),y(o,m),y(m,p),y(m,A),y(m,h),q||(O=be(p,"click",l[5]),q=!0)},p(b,w){w&2&&c!==(c=(b[1].message||"Unknown error occurred")+"")&&he(r,c)},i:j,o:j,d(b){b&&M(t),q=!1,O()}}}function Te(l){let t,o='<div class="flex flex-col items-center"><div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div> <p class="mt-4 text-xl font-medium">Loading your account...</p></div>';return{c(){t=C("div"),t.innerHTML=o,this.h()},l(e){t=P(e,"DIV",{class:!0,"data-svelte-h":!0}),N(t)!=="svelte-1g19t2"&&(t.innerHTML=o),this.h()},h(){v(t,"class","flex h-screen w-full items-center justify-center")},m(e,a){B(e,t,a)},p:j,i:j,o:j,d(e){e&&M(t)}}}function Ue(l){let t,o,e=Oe(l);return{c(){e&&e.c(),t=F()},l(a){e&&e.l(a),t=F()},m(a,u){e&&e.m(a,u),B(a,t,u),o=!0},p(a,[u]){e.p(a,u)},i(a){o||(H(e),o=!0)},o(a){V(e),o=!1},d(a){a&&M(t),e&&e.d(a)}}}function Ne(l,t,o){let e,a;X(l,oe,s=>o(10,e=s)),X(l,De,s=>o(11,a=s));let{$$slots:u={},$$scope:d}=t,{data:c}=t,r=c.sessionStatus==="loading"||c.sessionStatus==="initializing",_=c.error||null,m=!1,p=null,E=!1,A=!1;console.log("Account layout initializing"),console.log("Current session status:",c.sessionStatus),console.log("Current session state:",e);async function h(){if(!e?.user?.id||A)return!1;try{A=!0;const s=_e();if(!s)return!1;console.log(`Found pending map ID: ${s}`);const i=await je.connectToMap(s);return i.success?(console.log("Successfully connected to map:",i.data),$.set(i.data.connectedMap),ee.set(i.data.mapActivity),te.set(i.data.operations||[]),i.data.operation&&se.set(i.data.operation),W(),Z.success(`You've been connected to map: ${i.data.mapName}`),window.location.reload(),!0):(console.error("Failed to connect to map:",i.message),Z.error(`Failed to connect to map: ${i.message}`),W(),!1)}catch(s){return console.error("Error processing pending map connection:",s),W(),!1}}async function L(){if(!e?.user?.id)return null;const s=e.user.id;if(console.log("Loading user data for:",s),!A&&await h())return{pendingMapProcessing:!0};try{const[i,G]=await Promise.all([g.from("profiles").select("*").eq("id",s).single(),g.from("user_subscriptions").select("*").eq("user_id",s).single()]),n=i.data,f=G.data;if(console.log("Profile loaded:",n?.id),n&&qe.set({id:n.id,full_name:n.full_name,email:n.email,company_name:n.company_name,website:n.website,user_type:n.role,master_map_id:n.master_map_id,recent_maps:n.recent_maps,selected_operation_id:n.selected_operation_id}),f&&Ie.set({subscription:f.subscription,marker_limit:f.marker_limit,trail_limit:f.trail_limit,lingering_seats:f.lingering_seats,current_seats:f.current_seats,next_billing_date:f.next_billing_date}),!n?.master_map_id)return{profile:n,subscription:f,connected_map:null};const[z,ae,re]=await Promise.all([g.from("master_maps").select("*").eq("id",n.master_map_id).single(),Promise.all([g.from("map_markers").select("id",{count:"exact"}).eq("master_map_id",n.master_map_id),g.from("trail_data").select("id",{count:"exact"}).eq("master_map_id",n.master_map_id),g.from("profiles").select("id, full_name").eq("master_map_id",n.master_map_id)]),g.from("operations").select("*").eq("master_map_id",n.master_map_id)]),k=z.data,[ne,ie,K]=ae,R=re.data;if(console.log("Map data loaded:",k?.id),!k)return{profile:n,subscription:f,connected_map:null};const[le,ce,ue]=await Promise.all([g.from("profiles").select("full_name").eq("id",k.master_user_id).single(),g.from("user_subscriptions").select("*").eq("user_id",k.master_user_id).single(),g.from("vehicle_state").select("*").eq("master_map_id",n.master_map_id).in("vehicle_id",K.data?.map(T=>T.id)||[])]),D={id:k.id,map_name:k.map_name,master_user_id:k.master_user_id,owner:le.data?.full_name||"Unknown",is_owner:s===k.master_user_id},I={marker_count:ne.count||0,trail_count:ie.count||0,connected_profiles:K.data||[],vehicle_states:ue.data||[]},Q=ce.data;if($.set({id:D.id,map_name:D.map_name,master_user_id:D.master_user_id,owner:D.owner,is_owner:D.is_owner,masterSubscription:Q||null,is_connected:!0}),ee.set({marker_count:I.marker_count,trail_count:I.trail_count,connected_profiles:I.connected_profiles,vehicle_states:I.vehicle_states}),R?.length){te.set(R);const T=R.find(de=>de.id===n.selected_operation_id);T&&se.set(T)}return{profile:n,subscription:f,connected_map:D,map_activity:I,master_subscription:Q,operations:R}}catch(i){return console.error("Error loading user data:",i),o(1,_=i),null}}async function q(s,i,G){if(!s)return;const n={select_role:"/account/select_role",join_map:"/account/join_map",onboard_manager:"/account/onboard_manager",payment_plans:"/account/payment_plans",user_survey:"/account/user_survey",select_plan:"/account/select_plan"};if(!Object.values(n).some(z=>a.url.pathname===z||a.url.pathname.startsWith(z))){if(!s.role){x(n.select_role);return}if(!s.onboarded){if(s.role==="operator"){if(!i){x(n.join_map);return}}else if(s.role==="manager"){if(!G){x(n.payment_plans);return}x(n.onboard_manager);return}}}}function O(s,i){console.log("Auth State Change:",{event:s,hasSession:!!i,userId:i?.user?.id}),s==="SIGNED_OUT"&&!m&&(m=!0,x("/login"))}async function b(){try{if(!e?.user?.id){console.log("No valid session, redirecting to login"),m=!0,x("/login");return}const s=await L();if(E=!0,console.log("Loaded User Data:",s),s&&s.pendingMapProcessing)return;s&&await q(s.profile,s.connected_map,s.subscription),console.log("Data loading complete")}catch(s){console.error("Data loading error:",s),o(1,_=s)}finally{o(0,r=!1)}}async function w(){if(c.sessionPromise)try{if(!(await c.sessionPromise).isAuthenticated){console.log("Session not authenticated, redirecting to login"),m=!0,x("/login");return}await b()}catch(s){console.error("Error processing session:",s),o(1,_=s),o(0,r=!1)}else c.sessionStatus==="error"&&o(0,r=!1)}ge(()=>{console.log("Account layout mounted"),c.sessionPromise?w():e?.user?.id?b():r||(m=!0,x("/login"));const{data:s}=g.auth.onAuthStateChange(O);return p=s.subscription.unsubscribe,()=>{console.log("Account layout unmounting"),p&&p()}});const S=()=>window.location.reload();return l.$$set=s=>{"data"in s&&o(2,c=s.data),"$$scope"in s&&o(3,d=s.$$scope)},[r,_,c,d,u,S]}class tt extends Pe{constructor(t){super(),Ce(this,t,Ne,Ue,fe,{data:2})}}export{tt as component,et as universal};

import{s as ue,n as ne,d as c,i as ee,w as de,f as S,x as ie,k,z as fe,q as A,a as e,b as q,c as f,e as E,g as ae,h as p,j as h,t as _}from"../chunks/scheduler.BVGjjnGO.js";import{S as pe,i as he}from"../chunks/index.Vv2yv23T.js";import{g as _e}from"../chunks/entry.CJi6DTPP.js";import{a as $,s as ce}from"../chunks/sessionStore.rIZpZ3yf.js";function ge(g){let i,r,d,w="Authentication Error",t,l,o,s,n,m="Return to login",u,a,T,H,D=(g[2].hash||"none")+"",N,B,O,U,M=(g[2].query||"none")+"",V,J,L,j,G=(g[2].sessionResult||"pending")+"",F,K,Q,Y,W=g[2].profileCreated?"Yes":"No",z,X,v,C,x=(g[2].redirectTo||"default")+"",P;return{c(){i=h("div"),r=h("div"),d=h("h2"),d.textContent=w,t=k(),l=h("p"),o=_(g[1]),s=k(),n=h("a"),n.textContent=m,u=k(),a=h("div"),T=h("p"),H=_("Hash: "),N=_(D),B=k(),O=h("p"),U=_("Query: "),V=_(M),J=k(),L=h("p"),j=_("Session Result: "),F=_(G),K=k(),Q=h("p"),Y=_("Profile Created/Updated: "),z=_(W),X=k(),v=h("p"),C=_("Redirect To: "),P=_(x),this.h()},l(b){i=f(b,"DIV",{class:!0});var y=E(i);r=f(y,"DIV",{class:!0});var I=E(r);d=f(I,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-bznbjw"&&(d.textContent=w),t=S(I),l=f(I,"P",{class:!0});var Z=E(l);o=p(Z,g[1]),Z.forEach(c),s=S(I),n=f(I,"A",{href:!0,class:!0,"data-svelte-h":!0}),ae(n)!=="svelte-1m5fy2z"&&(n.textContent=m),u=S(I),a=f(I,"DIV",{class:!0});var R=E(a);T=f(R,"P",{});var te=E(T);H=p(te,"Hash: "),N=p(te,D),te.forEach(c),B=S(R),O=f(R,"P",{});var re=E(O);U=p(re,"Query: "),V=p(re,M),re.forEach(c),J=S(R),L=f(R,"P",{});var oe=E(L);j=p(oe,"Session Result: "),F=p(oe,G),oe.forEach(c),K=S(R),Q=f(R,"P",{});var se=E(Q);Y=p(se,"Profile Created/Updated: "),z=p(se,W),se.forEach(c),X=S(R),v=f(R,"P",{});var le=E(v);C=p(le,"Redirect To: "),P=p(le,x),le.forEach(c),R.forEach(c),I.forEach(c),y.forEach(c),this.h()},h(){q(d,"class","mb-4 text-xl font-semibold"),q(l,"class","text-red-500"),q(n,"href","/login"),q(n,"class","mt-4 inline-block rounded bg-blue-500 px-4 py-2 text-white"),q(a,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),q(r,"class","text-center"),q(i,"class","flex h-screen items-center justify-center")},m(b,y){ee(b,i,y),e(i,r),e(r,d),e(r,t),e(r,l),e(l,o),e(r,s),e(r,n),e(r,u),e(r,a),e(a,T),e(T,H),e(T,N),e(a,B),e(a,O),e(O,U),e(O,V),e(a,J),e(a,L),e(L,j),e(L,F),e(a,K),e(a,Q),e(Q,Y),e(Q,z),e(a,X),e(a,v),e(v,C),e(v,P)},p(b,y){y&2&&A(o,b[1]),y&4&&D!==(D=(b[2].hash||"none")+"")&&A(N,D),y&4&&M!==(M=(b[2].query||"none")+"")&&A(V,M),y&4&&G!==(G=(b[2].sessionResult||"pending")+"")&&A(F,G),y&4&&W!==(W=b[2].profileCreated?"Yes":"No")&&A(z,W),y&4&&x!==(x=(b[2].redirectTo||"default")+"")&&A(P,x)},d(b){b&&c(i)}}}function me(g){let i,r,d,w="Completing authentication...",t,l,o,s,n,m,u=(g[2].hash||"none")+"",a,T,H,D,N=(g[2].query||"none")+"",B,O,U,M,V=(g[2].sessionResult||"pending")+"",J,L,j,G,F=g[2].profileCreated?"Yes":"No",K,Q,Y,W,z=(g[2].redirectTo||"default")+"",X;return{c(){i=h("div"),r=h("div"),d=h("h2"),d.textContent=w,t=k(),l=h("div"),o=k(),s=h("div"),n=h("p"),m=_("Hash: "),a=_(u),T=k(),H=h("p"),D=_("Query: "),B=_(N),O=k(),U=h("p"),M=_("Session Result: "),J=_(V),L=k(),j=h("p"),G=_("Profile Created/Updated: "),K=_(F),Q=k(),Y=h("p"),W=_("Redirect To: "),X=_(z),this.h()},l(v){i=f(v,"DIV",{class:!0});var C=E(i);r=f(C,"DIV",{class:!0});var x=E(r);d=f(x,"H2",{class:!0,"data-svelte-h":!0}),ae(d)!=="svelte-lpwua0"&&(d.textContent=w),t=S(x),l=f(x,"DIV",{class:!0}),E(l).forEach(c),o=S(x),s=f(x,"DIV",{class:!0});var P=E(s);n=f(P,"P",{});var b=E(n);m=p(b,"Hash: "),a=p(b,u),b.forEach(c),T=S(P),H=f(P,"P",{});var y=E(H);D=p(y,"Query: "),B=p(y,N),y.forEach(c),O=S(P),U=f(P,"P",{});var I=E(U);M=p(I,"Session Result: "),J=p(I,V),I.forEach(c),L=S(P),j=f(P,"P",{});var Z=E(j);G=p(Z,"Profile Created/Updated: "),K=p(Z,F),Z.forEach(c),Q=S(P),Y=f(P,"P",{});var R=E(Y);W=p(R,"Redirect To: "),X=p(R,z),R.forEach(c),P.forEach(c),x.forEach(c),C.forEach(c),this.h()},h(){q(d,"class","mb-4 text-xl font-semibold"),q(l,"class","mx-auto h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"),q(s,"class","mt-8 rounded-lg bg-gray-50 p-4 text-left text-sm"),q(r,"class","text-center"),q(i,"class","flex h-screen items-center justify-center")},m(v,C){ee(v,i,C),e(i,r),e(r,d),e(r,t),e(r,l),e(r,o),e(r,s),e(s,n),e(n,m),e(n,a),e(s,T),e(s,H),e(H,D),e(H,B),e(s,O),e(s,U),e(U,M),e(U,J),e(s,L),e(s,j),e(j,G),e(j,K),e(s,Q),e(s,Y),e(Y,W),e(Y,X)},p(v,C){C&4&&u!==(u=(v[2].hash||"none")+"")&&A(a,u),C&4&&N!==(N=(v[2].query||"none")+"")&&A(B,N),C&4&&V!==(V=(v[2].sessionResult||"pending")+"")&&A(J,V),C&4&&F!==(F=v[2].profileCreated?"Yes":"No")&&A(K,F),C&4&&z!==(z=(v[2].redirectTo||"default")+"")&&A(X,z)},d(v){v&&c(i)}}}function ve(g){let i,r;function d(l,o){if(l[0])return me;if(l[1])return ge}let w=d(g),t=w&&w(g);return{c(){i=k(),t&&t.c(),r=ie(),this.h()},l(l){de("svelte-1ey0ckx",document.head).forEach(c),i=S(l),t&&t.l(l),r=ie(),this.h()},h(){document.title="Authentication"},m(l,o){ee(l,i,o),t&&t.m(l,o),ee(l,r,o)},p(l,[o]){w===(w=d(l))&&t?t.p(l,o):(t&&t.d(1),t=w&&w(l),t&&(t.c(),t.m(r.parentNode,r)))},i:ne,o:ne,d(l){l&&(c(i),c(r)),t&&t.d(l)}}}function Ee(g,i,r){let d=!0,w=null,t={hash:"",query:"",sessionResult:null,profileCreated:!1,redirectTo:""};async function l(o){try{console.log("Creating or updating profile for user:",o.user.id);const s={id:o.user.id,email:o.user.email,full_name:o.user.user_metadata?.full_name||null,avatar_url:o.user.user_metadata?.avatar_url||null,updated_at:new Date().toISOString(),onboarded:!1,last_sign_in:new Date().toISOString(),provider:o.user.app_metadata?.provider||"email"};console.log("User data prepared:",s);const{data:n,error:m}=await $.from("profiles").select("id, created_at, email").eq("id",o.user.id).single();if(m&&m.code!=="PGRST116")return console.error("Error checking existing profile:",m),!1;if(n){console.log("Existing profile found, updating:",n);const{error:u}=await $.from("profiles").update({last_sign_in:s.last_sign_in,updated_at:s.updated_at,...n.email?{}:{email:s.email},...n.full_name?{}:{full_name:s.full_name},...n.avatar_url?{}:{avatar_url:s.avatar_url}}).eq("id",o.user.id);return u?(console.error("Error updating profile:",u),!1):(console.log("Profile updated successfully"),!0)}else{console.log("No existing profile found, creating new profile");const{error:u}=await $.from("profiles").insert({...s,created_at:new Date().toISOString()});if(u&&u.code!=="23505")return console.error("Error creating profile:",u),!1;{console.log("Profile created successfully for user:",o.user.id);const{error:a}=await $.from("user_subscriptions").insert({user_id:o.user.id,subscription:"FREE",marker_limit:100,trail_limit:1e5,current_seats:1,updated_at:new Date().toISOString(),created_at:new Date().toISOString()});return a&&a.code!=="23505"?console.error("Error creating subscription:",a):console.log("Free subscription created for user:",o.user.id),!0}}}catch(s){return console.error("Error in profile creation/update:",s),!1}}return fe(async()=>{console.log("Auth callback mounting - PROFILE CREATION WILL HAPPEN HERE");try{r(2,t.hash=window.location.hash,t),r(2,t.query=window.location.search,t);const o=new URLSearchParams(window.location.hash.substring(1)),s=new URLSearchParams(window.location.search);r(2,t.redirectTo=s.get("next")||"/account",t),console.log("Auth callback parameters:",{hash:o.toString(),query:s.toString(),redirectTo:t.redirectTo});let n=null;if(window.location.hash){console.log("Processing hash fragment");const m=o.get("access_token"),u=o.get("refresh_token");if(m&&u){console.log("Setting session from tokens");const{data:a,error:T}=await $.auth.setSession({access_token:m,refresh_token:u});if(T)throw T;n=a.session,a.session&&(console.log("Manually updating session store"),ce.set(a.session),r(2,t.profileCreated=await l(a.session),t),console.log("Profile creation result:",t.profileCreated))}}else if(s.get("type")==="recovery"||s.get("type")==="signup"){console.log("Processing code exchange");const{data:m,error:u}=await $.auth.exchangeCodeForSession(s.get("code"));if(u)throw u;n=m.session,m.session&&(console.log("Manually updating session store from code exchange"),ce.set(m.session),r(2,t.profileCreated=await l(m.session),t),console.log("Profile creation result:",t.profileCreated))}r(2,t.sessionResult=n?"success":"failure",t),console.log("Auth process complete, redirecting to:",t.redirectTo),setTimeout(()=>{_e(t.redirectTo)},1e3)}catch(o){console.error("Error during auth callback:",o),r(1,w=o.message),r(2,t.sessionResult="error: "+o.message,t),r(0,d=!1)}}),[d,w,t]}class Ce extends pe{constructor(i){super(),he(this,i,Ee,ve,ue,{})}}export{Ce as component};

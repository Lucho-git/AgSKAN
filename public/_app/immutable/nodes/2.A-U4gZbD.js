import{i as ge,s as ne,a as h,g as he,c as K}from"../chunks/DSS83BMa.js";import"../chunks/SNxtA4zO.js";import{P as be,s as ye,d as M,i as J,z as G,l as ee,v as ve,n as O,b as S,c as A,g as H,j as D,q as ke,a as v,w as we,e as V,f as Q,h as xe,k as X,t as Pe,m as Se,u as Ce,o as Ae,p as De}from"../chunks/DjMlahvE.js";import{S as Me,i as qe,t as W,a as Y,g as Ie,e as Ee}from"../chunks/KhAD1Hhl.js";import{g as k}from"../chunks/DmiDxDTH.js";import{p as Re}from"../chunks/CmaL_1sX.js";import{t as te}from"../chunks/C31GE7Pe.js";import{C as je}from"../chunks/DU-NpqEO.js";import{p as Le}from"../chunks/C1kVPyTF.js";import{s as Oe}from"../chunks/D68R5yKn.js";import{c as ae}from"../chunks/BoF3N7P3.js";import{m as se}from"../chunks/C58cqHmn.js";import{o as re,s as oe}from"../chunks/BvQflP90.js";import{m as ze}from"../chunks/DLI7RhRl.js";const Te=async()=>{try{return{sessionStatus:"initializing",sessionPromise:ge().then(()=>{var s,e;const t=be(ne);return{isAuthenticated:!!((s=t==null?void 0:t.user)!=null&&s.id),userId:(e=t==null?void 0:t.user)==null?void 0:e.id}})}}catch(l){return console.error("Error in layout load:",l),{sessionStatus:"error",error:l.message}}},Ue=!1,nt=Object.freeze(Object.defineProperty({__proto__:null,load:Te,ssr:Ue},Symbol.toStringTag,{value:"Module"}));function Ne(l){let t,s,e,a;const d=[Ve,Fe,Be],m=[];function u(n,f){return n[0]?0:n[1]?1:2}return t=u(l),s=m[t]=d[t](l),{c(){s.c(),e=G()},l(n){s.l(n),e=G()},m(n,f){m[t].m(n,f),J(n,e,f),a=!0},p(n,f){let _=t;t=u(n),t===_?m[t].p(n,f):(Ie(),W(m[_],1,1,()=>{m[_]=null}),Ee(),s=m[t],s?s.p(n,f):(s=m[t]=d[t](n),s.c()),Y(s,1),s.m(e.parentNode,e))},i(n){a||(Y(s),a=!0)},o(n){W(s),a=!1},d(n){n&&M(e),m[t].d(n)}}}function Be(l){let t;const s=l[6].default,e=Se(s,l,l[5],null);return{c(){e&&e.c()},l(a){e&&e.l(a)},m(a,d){e&&e.m(a,d),t=!0},p(a,d){e&&e.p&&(!t||d&32)&&Ce(e,s,a,a[5],t?De(s,a[5],d,null):Ae(a[5]),null)},i(a){t||(Y(e,a),t=!0)},o(a){W(e,a),t=!1},d(a){e&&e.d(a)}}}function Fe(l){let t,s,e,a="Error Loading Account",d,m,u=(l[1].message||"Unknown error occurred")+"",n,f,_,g,z="Try Again",q,p,T="Back to Login",j,U;return{c(){t=D("div"),s=D("div"),e=D("h2"),e.textContent=a,d=X(),m=D("p"),n=Pe(u),f=X(),_=D("div"),g=D("button"),g.textContent=z,q=X(),p=D("a"),p.textContent=T,this.h()},l(w){t=A(w,"DIV",{class:!0});var x=V(t);s=A(x,"DIV",{class:!0});var C=V(s);e=A(C,"H2",{class:!0,"data-svelte-h":!0}),H(e)!=="svelte-135zzb6"&&(e.textContent=a),d=Q(C),m=A(C,"P",{class:!0});var N=V(m);n=xe(N,u),N.forEach(M),f=Q(C),_=A(C,"DIV",{class:!0});var r=V(_);g=A(r,"BUTTON",{class:!0,"data-svelte-h":!0}),H(g)!=="svelte-9gqfuk"&&(g.textContent=z),q=Q(r),p=A(r,"A",{href:!0,class:!0,"data-svelte-h":!0}),H(p)!=="svelte-abcnec"&&(p.textContent=T),r.forEach(M),C.forEach(M),x.forEach(M),this.h()},h(){S(e,"class","text-2xl font-bold text-red-700"),S(m,"class","mt-2 text-red-600"),S(g,"class","rounded bg-primary px-4 py-2 text-white"),S(p,"href","/login"),S(p,"class","rounded border border-gray-300 bg-white px-4 py-2 text-gray-700"),S(_,"class","mt-6 flex justify-center space-x-4"),S(s,"class","max-w-md rounded-lg bg-red-50 p-6 text-center shadow-lg"),S(t,"class","flex h-screen w-full items-center justify-center")},m(w,x){J(w,t,x),v(t,s),v(s,e),v(s,d),v(s,m),v(m,n),v(s,f),v(s,_),v(_,g),v(_,q),v(_,p),j||(U=we(g,"click",l[7]),j=!0)},p(w,x){x&2&&u!==(u=(w[1].message||"Unknown error occurred")+"")&&ke(n,u)},i:O,o:O,d(w){w&&M(t),j=!1,U()}}}function Ve(l){let t,s='<div class="flex flex-col items-center"><div class="h-16 w-16 animate-spin rounded-full border-4 border-primary border-t-transparent"></div> <p class="mt-4 text-xl font-medium">Loading your account...</p></div>';return{c(){t=D("div"),t.innerHTML=s,this.h()},l(e){t=A(e,"DIV",{class:!0,"data-svelte-h":!0}),H(t)!=="svelte-1g19t2"&&(t.innerHTML=s),this.h()},h(){S(t,"class","flex h-screen w-full items-center justify-center")},m(e,a){J(e,t,a)},p:O,i:O,o:O,d(e){e&&M(t)}}}function He(l){let t,s,e=Ne(l);return{c(){e&&e.c(),t=G()},l(a){e&&e.l(a),t=G()},m(a,d){e&&e.m(a,d),J(a,t,d),s=!0},p(a,[d]){e.p(a,d)},i(a){s||(Y(e),s=!0)},o(a){W(e),s=!1},d(a){a&&M(t),e&&e.d(a)}}}function Ge(l,t,s){let e,a;ee(l,Re,r=>s(4,e=r)),ee(l,ne,r=>s(12,a=r));let{$$slots:d={},$$scope:m}=t,{data:u}=t,n=u.sessionStatus==="loading"||u.sessionStatus==="initializing",f=u.error||null,_=!1,g=null,z=!1,q=!1,p=!1;console.log("Account layout initializing"),console.log("Current session status:",u.sessionStatus),console.log("Current session state:",a);async function T(){var r;if(!((r=a==null?void 0:a.user)!=null&&r.id)||q)return!1;try{q=!0;const o=he();if(!o)return!1;console.log(`Found pending map ID: ${o}`);const c=await ze.connectToMap(o);return c.success?(console.log("Successfully connected to map:",c.data),ae.set(c.data.connectedMap),se.set(c.data.mapActivity),re.set(c.data.operations||[]),c.data.operation&&oe.set(c.data.operation),K(),te.success(`You've been connected to map: ${c.data.mapName}`),window.location.reload(),!0):(console.error("Failed to connect to map:",c.message),te.error(`Failed to connect to map: ${c.message}`),K(),!1)}catch(o){return console.error("Error processing pending map connection:",o),K(),!1}}async function j(){var o,c,P;if(!((o=a==null?void 0:a.user)!=null&&o.id))return null;const r=a.user.id;if(console.log("Loading user data for:",r),!q&&await T())return{pendingMapProcessing:!0};try{const[I,B]=await Promise.all([h.from("profiles").select("*").eq("id",r).single(),h.from("user_subscriptions").select("*").eq("user_id",r).single()]),i=I.data,b=B.data;if(console.log("Profile loaded:",i==null?void 0:i.id),i&&Le.set({id:i.id,full_name:i.full_name,email:i.email,company_name:i.company_name,website:i.website,user_type:i.role,master_map_id:i.master_map_id,recent_maps:i.recent_maps,selected_operation_id:i.selected_operation_id}),b&&Oe.set({subscription:b.subscription,marker_limit:b.marker_limit,trail_limit:b.trail_limit,lingering_seats:b.lingering_seats,current_seats:b.current_seats,next_billing_date:b.next_billing_date}),!(i!=null&&i.master_map_id))return{profile:i,subscription:b,connected_map:null};const[ie,le,ce]=await Promise.all([h.from("master_maps").select("*").eq("id",i.master_map_id).single(),Promise.all([h.from("map_markers").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),h.from("trail_data").select("id",{count:"exact"}).eq("master_map_id",i.master_map_id),h.from("profiles").select("id, full_name").eq("master_map_id",i.master_map_id)]),h.from("operations").select("*").eq("master_map_id",i.master_map_id)]),y=ie.data,[ue,de,Z]=le,E=ce.data;if(console.log("Map data loaded:",y==null?void 0:y.id),!y)return{profile:i,subscription:b,connected_map:null};const[me,_e,pe]=await Promise.all([h.from("profiles").select("full_name").eq("id",y.master_user_id).single(),h.from("user_subscriptions").select("*").eq("user_id",y.master_user_id).single(),h.from("vehicle_state").select("*").eq("master_map_id",i.master_map_id).in("vehicle_id",((c=Z.data)==null?void 0:c.map(F=>F.id))||[])]),R={id:y.id,map_name:y.map_name,master_user_id:y.master_user_id,owner:((P=me.data)==null?void 0:P.full_name)||"Unknown",is_owner:r===y.master_user_id},L={marker_count:ue.count||0,trail_count:de.count||0,connected_profiles:Z.data||[],vehicle_states:pe.data||[]},$=_e.data;if(ae.set({id:R.id,map_name:R.map_name,master_user_id:R.master_user_id,owner:R.owner,is_owner:R.is_owner,masterSubscription:$||null,is_connected:!0}),se.set({marker_count:L.marker_count,trail_count:L.trail_count,connected_profiles:L.connected_profiles,vehicle_states:L.vehicle_states}),E!=null&&E.length){re.set(E);const F=E.find(fe=>fe.id===i.selected_operation_id);F&&oe.set(F)}return{profile:i,subscription:b,connected_map:R,map_activity:L,master_subscription:$,operations:E}}catch(I){return console.error("Error loading user data:",I),s(1,f=I),null}}async function U(r,o,c){if(!r)return;const P={select_role:"/account/select_role",join_map:"/account/join_map",onboard_manager:"/account/onboard_manager",payment_plans:"/account/payment_plans",user_survey:"/account/user_survey",select_plan:"/account/select_plan"},I=Object.values(P).some(B=>e.url.pathname===B||e.url.pathname.startsWith(B));if(p&&(e.url.pathname.includes("/payment")||e.url.pathname.includes("/select_plan")||e.url.pathname===P.payment_plans)){k("/account");return}if(!I){if(!r.role){k(P.select_role);return}if(!r.onboarded){if(r.role==="operator"){if(!o){k(P.join_map);return}}else if(r.role==="manager"){if(!c&&!p){k(P.payment_plans);return}k(P.onboard_manager);return}}}}function w(r,o){var c;console.log("Auth State Change:",{event:r,hasSession:!!o,userId:(c=o==null?void 0:o.user)==null?void 0:c.id}),r==="SIGNED_OUT"&&!_&&(_=!0,k("/login"))}async function x(){var r;try{if(!((r=a==null?void 0:a.user)!=null&&r.id)){console.log("No valid session, redirecting to login"),_=!0,k("/login");return}const o=await j();if(z=!0,console.log("Loaded User Data:",o),o&&o.pendingMapProcessing)return;o&&await U(o.profile,o.connected_map,o.subscription),console.log("Data loading complete")}catch(o){console.error("Data loading error:",o),s(1,f=o)}finally{s(0,n=!1)}}async function C(){if(u.sessionPromise)try{if(!(await u.sessionPromise).isAuthenticated){console.log("Session not authenticated, redirecting to login"),_=!0,k("/login");return}await x()}catch(r){console.error("Error processing session:",r),s(1,f=r),s(0,n=!1)}else u.sessionStatus==="error"&&s(0,n=!1)}ve(()=>{var o;console.log("Account layout mounted");try{s(3,p=je.isNativePlatform()),console.log("Running in native environment:",p)}catch(c){console.error("Error checking native platform:",c),s(3,p=!1)}u.sessionPromise?C():(o=a==null?void 0:a.user)!=null&&o.id?x():n||(_=!0,k("/login"));const{data:r}=h.auth.onAuthStateChange(w);return g=r.subscription.unsubscribe,()=>{console.log("Account layout unmounting"),g&&g()}});const N=()=>window.location.reload();return l.$$set=r=>{"data"in r&&s(2,u=r.data),"$$scope"in r&&s(5,m=r.$$scope)},l.$$.update=()=>{if(l.$$.dirty&24&&p&&e){const r=e.url.pathname;(r.includes("/payment")||r.includes("/select_plan")||r==="/account/payment_plans")&&(console.log("Skipping billing route in native app:",r),k("/account"))}},[n,f,u,p,e,m,d,N]}class it extends Me{constructor(t){super(),qe(this,t,Ge,He,ye,{data:2})}}export{it as component,nt as universal};
